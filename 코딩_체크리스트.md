# 사용자 계정 시스템 구현 체크리스트

**작성일**: 2025-01-27  
**목적**: 현재 코드 상태 확인 및 구현 필요 항목 정리

---

## 📊 현재 상태 분석

### ✅ 구현된 항목
- [x] 기존 라이선스 키 시스템 (서버 + 클라이언트)
- [x] ESP32 펌웨어 (송장번호 입력 기능)
- [x] 블루투스 컨트롤러 (시리얼 통신)
- [x] 엑셀 파일 읽기 기능
- [x] GUI 애플리케이션 기본 구조
- [x] 서버 기본 구조 (Flask + PostgreSQL/SQLite)

### ❌ 미구현 항목 (구현 필요)
- [ ] 사용자 계정 시스템 (전체)
- [ ] MAC 주소 검증 시스템 (전체)
- [ ] 로그인 화면
- [ ] 사용자 인증 모듈
- [ ] ESP32 MAC 주소 전송 기능

---

## 🗄️ Phase 1: 데이터베이스 구조 생성

### 서버 코드 수정 (`server/license_server.py`)

#### 1.1 `init_db()` 함수 수정
**현재 상태**: ❌ 기존 라이선스 테이블만 생성  
**필요 작업**: 
- [ ] `users` 테이블 생성 코드 추가
- [ ] `user_subscriptions` 테이블 생성 코드 추가
- [ ] `allowed_mac_addresses` 테이블 생성 코드 추가
- [ ] `user_usage` 테이블 생성 코드 추가
- [ ] `user_payments` 테이블 생성 코드 추가
- [ ] `mac_verification_log` 테이블 생성 코드 추가 (선택사항)
- [ ] PostgreSQL과 SQLite 모두 지원하도록 구현
- [ ] 인덱스 생성 코드 추가

**위치**: `server/license_server.py`의 `init_db()` 함수  
**라인 번호**: 약 47-193줄

---

## 🔌 Phase 2: 서버 API 구현

### 2.1 사용자 인증 API

#### POST /api/login
**현재 상태**: ❌ 미구현  
**필요 작업**:
- [ ] API 엔드포인트 추가 (`@app.route('/api/login', methods=['POST'])`)
- [ ] user_id, password 받기
- [ ] users 테이블에서 user_id 조회
- [ ] 비밀번호 해시 비교 (bcrypt)
- [ ] last_login 시간 업데이트
- [ ] user_info 반환 (user_id, name, email, expiry_date, is_active)
- [ ] 에러 처리 (아이디 없음, 비밀번호 틀림)

**위치**: `server/license_server.py`에 새 함수 추가  
**참고**: 가이드의 API 설계 섹션 참고

#### POST /api/logout
**현재 상태**: ❌ 미구현  
**필요 작업**:
- [ ] API 엔드포인트 추가
- [ ] user_id 받기
- [ ] 성공 메시지 반환

---

### 2.2 MAC 주소 검증 API

#### POST /api/verify_mac_address
**현재 상태**: ❌ 미구현  
**필요 작업**:
- [ ] API 엔드포인트 추가
- [ ] user_id, mac_address 받기
- [ ] allowed_mac_addresses 테이블에서 조회
- [ ] user_id와 mac_address 매칭 확인
- [ ] is_active 확인
- [ ] mac_verification_log에 기록 (선택사항)
- [ ] 허용/차단 결과 반환

---

### 2.3 사용자 관리 API (관리자)

#### POST /api/create_user
**현재 상태**: ❌ 미구현  
**필요 작업**:
- [ ] API 엔드포인트 추가
- [ ] admin_key 검증
- [ ] user_id, password, name, email, phone 받기
- [ ] 비밀번호 해싱 (bcrypt)
- [ ] users 테이블에 INSERT
- [ ] 기본 구독 생성 (선택사항)

#### POST /api/list_users
**현재 상태**: ❌ 미구현  
**필요 작업**:
- [ ] API 엔드포인트 추가
- [ ] admin_key 검증
- [ ] users 테이블에서 전체 사용자 조회
- [ ] user_subscriptions 테이블과 JOIN하여 expiry_date 포함
- [ ] 사용자 목록 반환

---

### 2.4 MAC 주소 관리 API (관리자)

#### POST /api/register_mac_address
**현재 상태**: ❌ 미구현  
**필요 작업**:
- [ ] API 엔드포인트 추가
- [ ] admin_key 검증
- [ ] user_id, mac_address, device_name 받기
- [ ] MAC 주소 형식 검증
- [ ] allowed_mac_addresses 테이블에 INSERT
- [ ] 중복 확인 (UNIQUE 제약조건)

#### POST /api/list_user_mac_addresses
**현재 상태**: ❌ 미구현  
**필요 작업**:
- [ ] API 엔드포인트 추가
- [ ] user_id 받기
- [ ] allowed_mac_addresses 테이블에서 해당 user_id의 MAC 주소 목록 조회
- [ ] 목록 반환

#### POST /api/remove_mac_address
**현재 상태**: ❌ 미구현  
**필요 작업**:
- [ ] API 엔드포인트 추가
- [ ] admin_key 검증
- [ ] user_id, mac_address 받기
- [ ] allowed_mac_addresses 테이블에서 DELETE
- [ ] 성공 메시지 반환

---

### 2.5 사용량 기록 API 수정

#### POST /api/record_user_usage (기존 API 수정)
**현재 상태**: ✅ 기존 API 있음 (`/api/record_usage`)  
**필요 작업**:
- [ ] 기존 API 수정 또는 새 API 추가
- [ ] license_key 대신 user_id 사용
- [ ] user_usage 테이블에 저장
- [ ] mac_address 필드 추가
- [ ] 기존 usage_stats 테이블 사용 중단 (선택사항)

**위치**: `server/license_server.py`의 `record_usage()` 함수  
**라인 번호**: 약 1052-1120줄

---

### 2.6 사용자 정보 조회 API

#### POST /api/user_info
**현재 상태**: ❌ 미구현 (기존 `/api/license_info` 있음)  
**필요 작업**:
- [ ] API 엔드포인트 추가
- [ ] user_id 받기
- [ ] users 테이블에서 조회
- [ ] user_subscriptions 테이블과 JOIN하여 expiry_date 포함
- [ ] 사용자 정보 반환

---

### 2.7 구독 관리 API (관리자)

#### POST /api/extend_user_subscription
**현재 상태**: ❌ 미구현 (기존 `/api/extend_license` 있음)  
**필요 작업**:
- [ ] API 엔드포인트 추가
- [ ] admin_key 검증
- [ ] user_id, period_days, amount, payment_method, note 받기
- [ ] user_subscriptions 테이블에서 현재 구독 조회
- [ ] expiry_date 연장
- [ ] user_payments 테이블에 결제 기록 저장
- [ ] 성공 메시지 및 새 expiry_date 반환

---

### 2.8 비밀번호 해싱 라이브러리

**필요 라이브러리**: `bcrypt`  
**현재 상태**: ❌ 서버 requirements.txt에 없음  
**필요 작업**:
- [ ] `server/requirements.txt`에 `bcrypt>=4.0.0` 추가
- [ ] 비밀번호 해싱 함수 구현
- [ ] 비밀번호 검증 함수 구현

**위치**: `server/requirements.txt`  
**현재 내용**: flask, flask-cors, werkzeug, gunicorn, psycopg2-binary만 있음

---

## 🔧 Phase 3: ESP32 펌웨어 수정

### MAC 주소 전송 기능 추가

#### `firmware/esp32_ble_hid/esp32_ble_hid.ino`
**현재 상태**: ❌ MAC 주소 전송 기능 없음  
**필요 작업**:
- [ ] "GET_CONNECTED_MAC" 명령 처리 추가
- [ ] 연결된 모바일 기기의 MAC 주소 확인 방법 구현
- [ ] BLE 연결 시 상대방 MAC 주소 저장
- [ ] 시리얼로 MAC 주소 전송

**위치**: `firmware/esp32_ble_hid/esp32_ble_hid.ino`  
**라인 번호**: `loop()` 함수 내 (약 63-130줄)

**주의사항**:
- ESP32 BLE Keyboard 라이브러리에서 연결된 장치의 MAC 주소를 얻는 방법 확인 필요
- BLE 연결 상태에서 MAC 주소 접근 가능 여부 확인 필요

---

## 💻 Phase 4: 클라이언트 프로그램 수정

### 4.1 사용자 인증 모듈 생성

#### `src/user_auth_manager.py` (신규 파일)
**현재 상태**: ❌ 파일 없음  
**필요 작업**:
- [ ] 새 파일 생성
- [ ] `UserAuthManager` 클래스 구현
- [ ] `login(user_id, password)` 메서드 구현
- [ ] `logout(user_id)` 메서드 구현
- [ ] `verify_mac_address(user_id, mac_address)` 메서드 구현
- [ ] `get_user_info(user_id)` 메서드 구현
- [ ] `save_session(user_info)` 메서드 구현
- [ ] `load_session()` 메서드 구현
- [ ] `clear_session()` 메서드 구현

**참고**: `src/online_license_manager.py` 참고하여 구조 설계

---

### 4.2 블루투스 컨트롤러 수정

#### `src/bluetooth_controller.py`
**현재 상태**: ❌ MAC 주소 확인 기능 없음  
**필요 작업**:
- [ ] `get_connected_mac_address()` 메서드 추가
- [ ] 시리얼 통신으로 "GET_CONNECTED_MAC" 명령 전송
- [ ] ESP32로부터 MAC 주소 수신
- [ ] MAC 주소 반환 (Optional[str])
- [ ] 에러 처리 (타임아웃, 연결 안 됨 등)

**위치**: `src/bluetooth_controller.py`  
**라인 번호**: 약 100줄 이후에 추가

---

### 4.3 GUI 애플리케이션 수정

#### `src/gui_app.py`

##### 4.3.1 초기화 부분 수정
**현재 상태**: ✅ `OnlineLicenseManager` 사용 중  
**필요 작업**:
- [ ] `OnlineLicenseManager` → `UserAuthManager`로 변경
- [ ] `check_license()` → `show_login()` 호출로 변경
- [ ] 기존 라이선스 검증 로직 제거

**위치**: `__init__` 메서드 (약 32-62줄)

##### 4.3.2 로그인 화면 추가
**현재 상태**: ❌ 로그인 화면 없음  
**필요 작업**:
- [ ] `show_login()` 메서드 추가
- [ ] 로그인 창 생성 (Toplevel 또는 초기 화면)
- [ ] 아이디 입력 필드
- [ ] 비밀번호 입력 필드 (show='*')
- [ ] 로그인 버튼
- [ ] 에러 메시지 표시 영역
- [ ] 로그인 성공 시 메인 화면 표시
- [ ] 로그인 실패 시 에러 메시지 표시
- [ ] 자동 로그인 기능 (세션 로드)

**위치**: `src/gui_app.py`에 새 메서드 추가

##### 4.3.3 사용자 정보 표시
**현재 상태**: ✅ 라이선스 정보 표시 중 (약 200-205줄)  
**필요 작업**:
- [ ] 라이선스 정보 → 사용자 정보로 변경
- [ ] 사용자 이름, 만료일 등 표시
- [ ] `license_manager.get_license_info()` → `user_auth_manager.get_user_info()` 사용

**위치**: `create_widgets()` 메서드 내 (약 200-205줄)

##### 4.3.4 MAC 주소 검증 통합
**현재 상태**: ❌ MAC 주소 검증 없음  
**필요 작업**:
- [ ] 프로그램 시작 시 MAC 주소 검증 함수 추가
- [ ] `verify_mac_address_on_start()` 메서드 추가
- [ ] ESP32 연결 확인
- [ ] MAC 주소 확인 (`bluetooth_controller.get_connected_mac_address()`)
- [ ] 서버에 MAC 주소 검증 요청
- [ ] 검증 실패 시 팝업 표시 및 프로그램 종료
- [ ] 자동화 실행 전 MAC 주소 재검증 추가

**위치**: `start_automation()` 메서드 내 (약 476-519줄)

##### 4.3.5 사용량 기록 수정
**현재 상태**: ✅ 기존 `record_usage()` 사용 중 (약 594-607줄)  
**필요 작업**:
- [ ] `license_manager.record_usage()` → `user_auth_manager.record_user_usage()` 변경
- [ ] user_id 포함
- [ ] mac_address 포함

**위치**: `run_automation()` 메서드 내 (약 594-607줄)

---

### 4.4 세션 관리

#### 세션 파일 (`config/session.json`)
**현재 상태**: ❌ 세션 파일 없음  
**필요 작업**:
- [ ] 세션 저장 위치: `config/session.json`
- [ ] 세션 정보: user_id, name, login_time
- [ ] 세션 저장 기능 (`user_auth_manager.py`에 구현)
- [ ] 세션 로드 기능
- [ ] 세션 삭제 기능
- [ ] 세션 만료 확인 (선택사항)

---

## 🖥️ Phase 5: 웹 관리 페이지 수정

### 5.1 사용자 관리 페이지

#### `server/templates/users.html` (신규 파일)
**현재 상태**: ❌ 파일 없음  
**필요 작업**:
- [ ] 새 파일 생성
- [ ] 사용자 목록 표시
- [ ] 사용자 추가 폼
- [ ] 사용자 정보 수정
- [ ] 사용자 활성화/비활성화
- [ ] 사용자 삭제 기능
- [ ] JavaScript로 API 호출

**또는**: `index.html`에 탭으로 통합

---

### 5.2 MAC 주소 관리 기능

#### `server/templates/index.html` 수정
**현재 상태**: ✅ 기본 관리 페이지 있음  
**필요 작업**:
- [ ] 사용자별 MAC 주소 관리 탭 추가
- [ ] MAC 주소 목록 표시
- [ ] MAC 주소 추가 폼
- [ ] MAC 주소 삭제 기능
- [ ] JavaScript로 API 호출

**위치**: `server/templates/index.html`

---

### 5.3 기존 관리 페이지 수정

#### 라이선스 관리 → 사용자 관리로 변경
**현재 상태**: ✅ 라이선스 관리 기능 있음  
**필요 작업**:
- [ ] 라이선스 관리 탭 → 사용자 관리 탭으로 변경 (또는 추가)
- [ ] 사용자 목록 API 호출
- [ ] 사용자별 사용 통계 표시
- [ ] 사용자별 결제 내역 표시

**위치**: `server/templates/index.html`

---

## 📦 라이브러리 및 의존성

### 서버 의존성 (`server/requirements.txt`)
**현재 내용**:
```
flask>=2.0.0
flask-cors>=3.0.0
werkzeug>=2.0.0
gunicorn>=20.1.0
psycopg2-binary>=2.9.0
```

**추가 필요**:
- [ ] `bcrypt>=4.0.0` 추가 (비밀번호 해싱)

---

### 클라이언트 의존성 (`requirements.txt`)
**현재 상태**: ✅ 확인 필요  
**필요 작업**:
- [ ] `bcrypt` 필요 여부 확인 (클라이언트는 필요 없을 수도 있음)
- [ ] 기존 라이브러리 그대로 사용 가능

---

## ✅ 구현 우선순위

### 1단계: 핵심 기능 (필수)
1. 데이터베이스 테이블 생성
2. POST /api/login 구현
3. POST /api/verify_mac_address 구현
4. UserAuthManager 클래스 생성
5. 로그인 화면 추가
6. MAC 주소 확인 기능 (ESP32 + 클라이언트)

### 2단계: 관리 기능
1. POST /api/create_user 구현
2. POST /api/list_users 구현
3. POST /api/register_mac_address 구현
4. 웹 관리 페이지 사용자 관리 기능

### 3단계: 추가 기능
1. POST /api/logout 구현
2. POST /api/user_info 구현
3. POST /api/extend_user_subscription 구현
4. 사용량 기록 API 수정
5. 세션 관리 완성

---

## 🔍 코드 수정 위치 요약

### 서버 (`server/license_server.py`)
- **init_db()**: 약 47-193줄 → 테이블 생성 코드 추가
- **새 API 추가**: 파일 끝부분에 추가 (약 1236줄 이후)

### 클라이언트 (`src/gui_app.py`)
- **__init__()**: 약 32-62줄 → UserAuthManager로 변경, show_login() 호출
- **create_widgets()**: 약 200-205줄 → 사용자 정보 표시로 변경
- **start_automation()**: 약 476-519줄 → MAC 주소 검증 추가
- **run_automation()**: 약 594-607줄 → 사용량 기록 수정

### ESP32 (`firmware/esp32_ble_hid/esp32_ble_hid.ino`)
- **loop()**: 약 63-130줄 → MAC 주소 전송 기능 추가

---

## 📝 참고 파일

### 구현 가이드
- `사용자_계정_시스템_구현_가이드.md` - 전체 구현 가이드

### 참고할 기존 코드
- `src/online_license_manager.py` - UserAuthManager 구조 참고
- `server/license_server.py` - API 구현 패턴 참고
- `src/gui_app.py` - GUI 구조 참고

---

## ⚠️ 주의사항

1. **기존 라이선스 키 시스템 유지 여부 결정**
   - 완전히 제거할지
   - 병행 지원할지
   - 점진적 전환할지

2. **데이터 마이그레이션**
   - 기존 라이선스 키 사용자가 있다면 마이그레이션 계획 필요

3. **ESP32 MAC 주소 접근**
   - BLE Keyboard 라이브러리에서 MAC 주소 접근 가능 여부 확인 필요
   - 불가능하면 대안 방법 고려

4. **테스트**
   - 각 단계별로 테스트 필수
   - 서버 API 테스트
   - 클라이언트 통합 테스트
   - ESP32 펌웨어 테스트

---

**작성일**: 2025-01-27  
**상태**: 구현 전 체크리스트 완료





