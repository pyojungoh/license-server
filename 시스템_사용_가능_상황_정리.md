# 프로그램 및 ESP32 사용 가능/불가능 상황 정리

## ✅ 사용 가능한 상황

### 1. 정상적인 사용 상황

#### 조건
- ✅ 서버에 등록된 사용자 ID/비밀번호로 로그인
- ✅ 첫 로그인 시 해당 모바일 기기가 자동 등록됨
- ✅ 구독 기간이 만료되지 않음 (expiry_date가 미래)
- ✅ 사용자 계정이 활성화되어 있음 (is_active = true)
- ✅ 모바일 앱에서 ESP32에 성공적으로 토큰 전송
- ✅ ESP32가 모바일 기기와 블루투스 연결됨
- ✅ PC와 ESP32가 USB 시리얼로 연결됨

#### 사용 흐름
```
1. 모바일 앱 실행 → 로그인 (ID/비밀번호)
   └─> 서버가 기기 UUID 확인/등록
   └─> 액세스 토큰 발급
   
2. 모바일 앱에서 "ESP32 장치 검색" → 연결
   └─> 토큰 전송 → ESP32 LED 켜짐 (인증 성공)
   
3. PC 프로그램 실행 → 로그인
   └─> COM 포트 선택 → Excel 파일 선택
   └─> 자동화 시작 → ESP32가 키보드 입력 실행
```

---

## ❌ 사용 불가능한 상황

### 1. 인증 관련 문제

#### 1.1 다른 기기에서 로그인 시도
**상황**: 친구의 폰에서 내 ID/비밀번호로 로그인
- ❌ **결과**: 403 에러, "등록된 기기가 아닙니다"
- **이유**: 서버에 등록된 기기 UUID와 다른 기기 UUID로 로그인 시도
- **해결**: 관리자 페이지에서 기기 삭제 후 새 기기로 재등록

#### 1.2 구독 만료
**상황**: 구독 기간이 지남
- ❌ **결과**: 로그인은 가능하지만 자동화 기능 제한될 수 있음
- **이유**: `expiry_date`가 과거 날짜
- **해결**: 관리자 페이지에서 구독 연장

#### 1.3 계정 비활성화
**상황**: 관리자가 계정을 비활성화
- ❌ **결과**: 로그인 불가 또는 기능 제한
- **이유**: `is_active = false`
- **해결**: 관리자에게 계정 활성화 요청

#### 1.4 토큰 만료
**상황**: 액세스 토큰의 유효기간이 지남
- ❌ **결과**: ESP32 인증 실패
- **이유**: 토큰의 `expires_at` 시간 경과
- **해결**: 모바일 앱에서 재로그인 (새 토큰 발급)

---

### 2. 하드웨어/연결 문제

#### 2.1 ESP32와 모바일 블루투스 연결 안 됨
**상황**: ESP32 전원이 꺼져 있거나 블루투스가 비활성화
- ❌ **결과**: 앱에서 ESP32 장치를 찾을 수 없음
- **해결**: 
  - ESP32 전원 확인
  - 모바일 기기 블루투스 켜기
  - ESP32와 모바일 기기 페어링 확인

#### 2.2 ESP32가 토큰을 받지 못함
**상황**: 블루투스는 연결되었지만 GATT 서비스 연결 실패
- ❌ **결과**: ESP32 LED가 켜지지 않음, 키보드 기능 비활성화
- **이유**: 
  - Custom BLE Service가 어드버타이징되지 않음
  - GATT 연결 실패
- **해결**:
  - ESP32 펌웨어 재업로드
  - 모바일 앱에서 토큰 재전송

#### 2.3 PC와 ESP32 USB 연결 안 됨
**상황**: USB 케이블이 빠지거나 COM 포트 인식 실패
- ❌ **결과**: PC 프로그램에서 ESP32와 통신 불가
- **해결**:
  - USB 케이블 확인
  - COM 포트 확인 (장치 관리자)
  - CH340 드라이버 재설치

---

### 3. 네트워크/서버 문제

#### 3.1 서버 다운
**상황**: Railway 서버가 중단되거나 오류 발생
- ❌ **결과**: 로그인 실패, 토큰 발급 불가
- **해결**: 서버 상태 확인, 재배포 필요

#### 3.2 인터넷 연결 없음
**상황**: 모바일 기기나 PC에 인터넷이 없음
- ❌ **결과**: 로그인 불가
- **이유**: 서버 인증이 필요함
- **해결**: 인터넷 연결 확인

---

### 4. 기기 변경 시나리오

#### 4.1 모바일 기기 교체 (첫 30일 이내)
**상황**: 새 폰으로 바꿨는데 아직 30일이 안 지남
- ❌ **결과**: 기기 변경 신청 불가
- **이유**: 기기 변경은 30일마다 1회만 가능
- **해결**: 
  - 관리자 페이지에서 기존 기기 수동 삭제
  - 또는 30일 후 기기 변경 신청

#### 4.2 동시에 여러 기기에서 사용
**상황**: 내 폰과 친구 폰에서 동시에 사용
- ❌ **결과**: 한 기기만 사용 가능
- **이유**: 한 사용자는 한 기기에만 등록 가능 (1인 1기기 정책)
- **해결**: 한 기기에서만 사용

---

## 🔄 재사용 가능한 상황

### 1. 정상적인 재사용
- ✅ 같은 모바일 기기, 같은 PC에서 매일 사용
- ✅ 구독 기간 내에서 무제한 사용 가능
- ✅ 매번 로그인은 필요하지만, 기기 등록은 한 번만

### 2. 재로그인 필요
- ✅ 토큰 만료 시
- ✅ 앱 재설치 시
- ✅ 모바일 기기 초기화 시

---

## 📋 체크리스트

### 사용 전 확인사항
- [ ] 서버에 사용자 계정이 등록되어 있음
- [ ] 구독 기간이 유효함
- [ ] 모바일 앱이 설치되어 있고 로그인 가능
- [ ] ESP32 전원이 켜져 있음
- [ ] ESP32와 모바일 기기가 블루투스로 연결됨
- [ ] PC와 ESP32가 USB로 연결됨
- [ ] 인터넷 연결됨 (로그인 시)

### 문제 발생 시 확인
1. **로그인 안 됨** → 서버 상태, 계정 상태, 구독 기간 확인
2. **ESP32 찾을 수 없음** → 블루투스 연결, 페어링 확인
3. **토큰 전송 실패** → GATT 연결 확인, ESP32 펌웨어 확인
4. **키보드 입력 안 됨** → ESP32 LED 확인, 토큰 인증 확인
5. **403 에러** → 기기 UUID 불일치, 관리자 페이지에서 기기 삭제 후 재등록

---

## 💡 요약

### ✅ 사용 가능
- 등록된 사용자
- 유효한 구독 기간
- 등록된 기기
- 정상적인 하드웨어 연결
- 서버 정상 작동

### ❌ 사용 불가
- 다른 기기에서 로그인
- 구독 만료
- 계정 비활성화
- 하드웨어 연결 문제
- 서버 다운
- 기기 변경 제한 (30일)

### 🔄 재사용
- 같은 기기에서 계속 사용 가능
- 토큰 만료 시 재로그인 필요
- 구독 기간 내 무제한 사용







