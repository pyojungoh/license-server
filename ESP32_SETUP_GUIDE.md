# ESP32 칩셋 셋업 가이드

새로운 ESP32 개발 보드를 처음부터 셋업하는 방법입니다.

---

## 📦 준비물

- ESP32 개발 보드 (USB-C 타입)
- USB-C 케이블 (데이터 전송 가능한 케이블)
- PC (Windows)
- 모바일 기기 (Android/iOS)

---

## 1단계: 드라이버 설치 (5분)

### 1.1 드라이버 다운로드
1. 웹 브라우저에서 다음 링크 열기:
   - http://www.wch.cn/downloads/CH341SER_EXE.html
2. **CH341SER.EXE** 파일 다운로드

### 1.2 드라이버 설치
1. 다운로드한 **CH341SER.EXE** 실행
2. 관리자 권한 요청 시 **예** 클릭
3. **INSTALL** 버튼 클릭
4. "The driver has been installed successfully!" 메시지 확인

### 1.3 설치 확인
1. ESP32를 PC에 연결 (USB-C 케이블 사용)
2. `Win + X` → **장치 관리자**
3. **포트(COM & LPT)** 확장
4. **USB-SERIAL CH340 (COMx)** 확인
5. **COM 번호 기록** (예: COM3, COM10 등)

---

## 2단계: Arduino IDE 설정 (20분)

### 2.1 Arduino IDE 설치
1. https://www.arduino.cc/en/software 방문
2. Arduino IDE 다운로드 및 설치

### 2.2 ESP32 보드 패키지 추가
1. Arduino IDE 실행
2. **파일 → 환경설정** (또는 `Ctrl + ,`)
3. **추가 보드 관리자 URL**에 다음 URL 추가:
   ```
   https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
   ```
4. **확인** 클릭

### 2.3 ESP32 보드 설치
1. **도구 → 보드 → 보드 관리자**
2. 검색창에 `esp32` 입력
3. **esp32 by Espressif Systems** 선택
4. **설치** 클릭 (다운로드 및 설치에 시간 소요)

### 2.4 보드 및 포트 선택
1. **도구 → 보드 → ESP32 Arduino → ESP32 Dev Module**
2. **도구 → 포트 → COMx** (1단계에서 확인한 COM 번호)

### 2.5 BLE 키보드 라이브러리 설치
1. **스케치 → 라이브러리 포함하기 → 라이브러리 관리**
2. 검색창에 `ESP32 BLE Keyboard` 입력
3. 라이브러리 관리자에서 찾을 수 없으면:
   - GitHub에서 다운로드: https://github.com/T-vK/ESP32-BLE-Keyboard
   - **스케치 → 라이브러리 포함하기 → .ZIP 라이브러리 추가**
   - 다운로드한 ZIP 파일 선택

---

## 3단계: 라이브러리 수정 (필수!)

ESP32 보드 패키지 3.3.5와 호환되도록 라이브러리를 수정해야 합니다.

### 3.1 라이브러리 파일 찾기
1. 파일 탐색기에서 다음 경로로 이동:
   ```
   C:\Arduino\libraries\ESP32_BLE_Keyboard\
   ```
   (또는 스케치북 위치의 libraries 폴더)

### 3.2 파일 수정
1. `BleKeyboard.cpp` 파일을 메모장이나 코드 에디터로 열기
2. **105번째 줄** 찾기:
   ```cpp
   BLEDevice::init(deviceName);
   ```
   다음으로 변경:
   ```cpp
   BLEDevice::init(String(deviceName.c_str()));
   ```

3. **116번째 줄** 찾기:
   ```cpp
   hid->manufacturer()->setValue(deviceManufacturer);
   ```
   다음으로 변경:
   ```cpp
   hid->manufacturer()->setValue(String(deviceManufacturer.c_str()));
   ```

4. 파일 저장

---

## 4단계: 펌웨어 업로드 (10분)

### 4.1 펌웨어 파일 열기
1. Arduino IDE에서 **파일 → 열기**
2. 다음 경로의 파일 열기:
   ```
   C:\hanjin\firmware\esp32_ble_hid\esp32_ble_hid.ino
   ```

### 4.2 보드 및 포트 확인
1. **도구 → 보드 → ESP32 Arduino → ESP32 Dev Module** 선택
2. **도구 → 포트 → COMx** 선택 (1단계에서 확인한 COM 번호)

### 4.3 펌웨어 업로드
1. **스케치 → 업로드** (또는 `Ctrl + U`)
2. 업로드 진행 대기 (약 1~2분)

**업로드 실패 시:**
- ESP32의 **BOOT 버튼** 찾기
- **BOOT 버튼을 누른 상태**에서 업로드 시작
- "연결 중..." 메시지가 나오면 버튼 놓기

### 4.4 업로드 확인
1. **도구 → 시리얼 모니터** (또는 `Ctrl + Shift + M`)
2. 보레이트: **115200** 선택
3. 다음 메시지가 보이면 성공:
   ```
   =================================
   ESP32 BLE HID 키보드 시작
   =================================
   블루투스 키보드 초기화 완료
   모바일 기기에서 '한진택배 스캐너'를 찾아 페어링하세요.
   블루투스 연결 대기 중...
   ```

---

## 5단계: 블루투스 페어링 (5분)

### 5.1 모바일에서 페어링
1. 모바일 기기의 **설정 → 블루투스** 열기
2. 사용 가능한 장치 목록에서 **"한진택배 스캐너"** 찾기
3. **페어링** 클릭
4. 페어링 완료 확인

### 5.2 연결 확인
1. Arduino IDE 시리얼 모니터 확인
2. **"✓ 블루투스 연결됨!"** 메시지 확인

### 5.3 테스트
1. 모바일에서 **메모장** 앱 열기
2. 입력 필드에 커서 두기
3. 시리얼 모니터에서 `테스트123` 입력 후 엔터
4. 메모장에 텍스트가 입력되는지 확인

---

## 6단계: 설정 파일 수정 (2분)

### 6.1 COM 포트 번호 확인
1. 장치 관리자에서 COM 포트 번호 확인 (1단계에서 기록한 번호)

### 6.2 설정 파일 수정
1. 다음 파일 열기:
   ```
   C:\hanjin\config\settings.json
   ```
2. `"port": "COM3"` 부분을 실제 COM 번호로 변경:
   ```json
   {
     "serial": {
       "port": "COM10",  ← 여기를 실제 COM 번호로 변경!
       "baudrate": 115200,
       "timeout": 1.0
     },
     ...
   }
   ```
3. 파일 저장

---

## 7단계: Python 프로그램 실행 (5분)

### 7.1 엑셀 파일 준비
1. `C:\hanjin\data\` 폴더에 `invoices.xlsx` 파일 생성
2. 첫 번째 행(헤더)에 `InvoiceNumber` 입력
3. 두 번째 행부터 송장번호 입력
   - **중요**: 숫자 형식이 아닌 **텍스트 형식**으로 저장 (앞자리 0 보존)

### 7.2 Python 라이브러리 설치
터미널에서 실행:
```bash
cd C:\hanjin
pip install -r requirements.txt
```

### 7.3 실행 순서
1. **Arduino IDE 완전 종료** (시리얼 모니터도 닫기)
2. 모바일에서 **블루투스 연결 확인**
3. **한진택배 앱** 열고 입력 필드 활성화
4. Python 프로그램 실행:
   ```bash
   cd C:\hanjin\src
   python main.py
   ```
5. 확인 메시지에 `y` 입력

---

## 🐛 문제 해결

### 문제 1: COM 포트 인식 안 됨
**해결**:
- USB 케이블 교체 (데이터 전송 가능한 케이블)
- 다른 USB 포트 시도
- CH340 드라이버 재설치

### 문제 2: 펌웨어 업로드 실패
**해결**:
- ESP32의 **BOOT 버튼** 누른 상태에서 업로드
- 보드 및 포트 선택 확인
- Arduino IDE 재시작

### 문제 3: 블루투스 페어링 실패
**해결**:
- 모바일에서 기존 연결 삭제 후 재시도
- ESP32 **EN 버튼** 눌러서 재부팅
- 모바일 블루투스 재시작

### 문제 4: 블루투스 연결은 되는데 입력이 안 됨
**해결**:
1. 모바일에서 블루투스 삭제
2. ESP32 **EN 버튼** 눌러서 재부팅
3. 모바일에서 다시 페어링
4. Arduino IDE 완전 종료
5. Python 프로그램 실행

### 문제 5: Python 실행 시 COM 포트 오류
**해결**:
- Arduino IDE가 완전히 종료되었는지 확인
- 다른 프로그램에서 포트 사용 중인지 확인
- COM 포트 번호가 올바른지 확인 (`config/settings.json`)

### 문제 6: 컴파일 오류 (std::string 관련)
**해결**:
- 3단계의 라이브러리 수정이 제대로 되었는지 확인
- `BleKeyboard.cpp` 파일의 105번째, 116번째 줄 확인

---

## ✅ 체크리스트

셋업 완료 확인:

- [ ] 드라이버 설치 완료
- [ ] COM 포트 번호 확인 완료
- [ ] Arduino IDE 설치 및 ESP32 보드 패키지 설치 완료
- [ ] BLE 키보드 라이브러리 설치 및 수정 완료
- [ ] 펌웨어 업로드 성공
- [ ] 시리얼 모니터에서 정상 메시지 확인
- [ ] 모바일과 블루투스 페어링 완료
- [ ] 메모장에서 입력 테스트 성공
- [ ] 설정 파일 COM 포트 번호 수정 완료
- [ ] Python 프로그램 실행 성공

---

## 📝 참고사항

### 버튼 설명
- **EN 버튼**: ESP32 재부팅 (블루투스 연결 문제 시 사용)
- **BOOT 버튼**: 펌웨어 업로드 모드 (업로드 실패 시 사용)

### 실행 순서 (매번)
1. Arduino IDE 완전 종료
2. 모바일 블루투스 연결 확인
3. 한진택배 앱 준비 (입력 필드 활성화)
4. Python 프로그램 실행

### 주의사항
- Arduino IDE와 Python 프로그램은 동시에 실행할 수 없습니다
- COM 포트는 한 번에 하나의 프로그램만 사용할 수 있습니다
- 블루투스 연결이 끊기면 ESP32 EN 버튼으로 재부팅하세요

---

**작성일**: 2024-12-26  
**버전**: 1.0

