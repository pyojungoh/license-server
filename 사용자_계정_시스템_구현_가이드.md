# 사용자 계정 시스템 구현 가이드

## 📋 개요

라이선스 키 방식에서 사용자 계정(아이디/비밀번호) 방식으로 전환하여, 한 대의 컴퓨터에서 여러 사용자가 각각의 계정으로 사용할 수 있도록 구현하는 가이드입니다.

---

## 🎯 목표

1. **사용자별 계정 관리**: 아이디/비밀번호 기반 로그인 시스템
2. **MAC 주소 기반 검증**: 등록된 휴대폰만 사용 가능
3. **사용자별 과금 관리**: 사용자별 사용료 추적 및 결제
4. **사용량 추적**: 사용자별 사용 통계 관리

---

## 📊 시스템 아키텍처

### 전체 흐름

```
[클라이언트 프로그램]
    ↓
1. 로그인 화면 (아이디/비밀번호)
    ↓
2. 로그인 API 호출
    ↓
[Railway 서버]
    ↓
3. 사용자 인증 (비밀번호 확인)
    ↓
4. MAC 주소 확인 및 검증
    ↓
5. 사용자 계정 활성화 상태 확인
    ↓
6. 검증 결과 반환
    ↓
[클라이언트 프로그램]
    ↓
7. 허용 → 정상 사용 / 차단 → 팝업 표시 및 사용 불가
```

---

## 💾 데이터베이스 구조

### 1. `users` 테이블 (신규)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(100) UNIQUE NOT NULL,          -- 사용자 아이디
    password_hash VARCHAR(255) NOT NULL,           -- 비밀번호 해시 (bcrypt)
    name VARCHAR(100) NOT NULL,                    -- 이름
    email VARCHAR(100),                            -- 이메일
    phone VARCHAR(20),                             -- 전화번호
    hardware_id VARCHAR(255),                      -- PC 하드웨어 ID (선택사항)
    created_date TIMESTAMP DEFAULT NOW(),          -- 생성일
    last_login TIMESTAMP,                          -- 마지막 로그인 시간
    is_active BOOLEAN DEFAULT TRUE                 -- 활성화 여부
);
```

**인덱스**:
- `user_id`에 UNIQUE 인덱스
- `email`에 인덱스 (선택사항)

---

### 2. `user_subscriptions` 테이블 (신규)

```sql
CREATE TABLE user_subscriptions (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,                 -- 사용자 아이디
    subscription_type VARCHAR(50) DEFAULT 'monthly', -- 구독 타입 (monthly, yearly, pay_per_use 등)
    start_date TIMESTAMP NOT NULL,                 -- 시작일
    expiry_date TIMESTAMP NOT NULL,                -- 만료일
    is_active BOOLEAN DEFAULT TRUE,                -- 활성화 여부
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);
```

**인덱스**:
- `user_id`에 인덱스
- `expiry_date`에 인덱스

---

### 3. `allowed_mac_addresses` 테이블 (신규)

```sql
CREATE TABLE allowed_mac_addresses (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,                 -- 사용자 아이디
    mac_address VARCHAR(17) NOT NULL,              -- MAC 주소 (예: "AA:BB:CC:DD:EE:FF")
    device_name VARCHAR(100),                      -- 장치 이름 (예: "삼성 갤럭시 S21")
    registered_date TIMESTAMP DEFAULT NOW(),       -- 등록일
    is_active BOOLEAN DEFAULT TRUE,                -- 활성화 여부
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    UNIQUE(user_id, mac_address)                   -- 같은 사용자에게 중복 MAC 주소 방지
);
```

**인덱스**:
- `user_id`에 인덱스
- `mac_address`에 인덱스
- `(user_id, mac_address)` 복합 인덱스

---

### 4. `user_usage` 테이블 (신규)

```sql
CREATE TABLE user_usage (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,                 -- 사용자 아이디
    usage_date TIMESTAMP NOT NULL,                 -- 사용 일시
    total_invoices INTEGER DEFAULT 0,              -- 총 송장 수
    success_count INTEGER DEFAULT 0,               -- 성공 건수
    fail_count INTEGER DEFAULT 0,                  -- 실패 건수
    hardware_id VARCHAR(255),                      -- 사용한 PC 하드웨어 ID
    mac_address VARCHAR(17),                       -- 사용한 휴대폰 MAC 주소
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);
```

**인덱스**:
- `user_id`에 인덱스
- `usage_date`에 인덱스
- `(user_id, usage_date)` 복합 인덱스

---

### 5. `user_payments` 테이블 (신규)

```sql
CREATE TABLE user_payments (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,                 -- 사용자 아이디
    payment_date TIMESTAMP NOT NULL,               -- 결제일
    amount DECIMAL(10, 2) NOT NULL,                -- 결제 금액
    period_days INTEGER NOT NULL,                  -- 기간 (일)
    payment_method VARCHAR(50),                    -- 결제 방법 (현금, 계좌이체, 카드 등)
    note TEXT,                                     -- 비고
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);
```

**인덱스**:
- `user_id`에 인덱스
- `payment_date`에 인덱스

---

### 6. `mac_verification_log` 테이블 (선택사항, 로그용)

```sql
CREATE TABLE mac_verification_log (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,                 -- 사용자 아이디
    mac_address VARCHAR(17) NOT NULL,              -- 검증 시도한 MAC 주소
    verification_result VARCHAR(20) NOT NULL,      -- 검증 결과 (ALLOWED, DENIED)
    verification_date TIMESTAMP DEFAULT NOW(),     -- 검증 시도 시간
    ip_address VARCHAR(50),                        -- 클라이언트 IP 주소
    hardware_id VARCHAR(255),                      -- PC 하드웨어 ID
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);
```

**인덱스**:
- `user_id`에 인덱스
- `verification_date`에 인덱스
- `mac_address`에 인덱스

---

## 🔌 서버 API 설계

### 1. 사용자 인증 API

#### POST /api/login
**요청**:
```json
{
    "user_id": "사용자아이디",
    "password": "비밀번호",
    "hardware_id": "PC하드웨어ID" (선택사항)
}
```

**응답 (성공)**:
```json
{
    "success": true,
    "message": "로그인 성공",
    "user_info": {
        "user_id": "사용자아이디",
        "name": "홍길동",
        "email": "user@example.com",
        "expiry_date": "2025-12-31T23:59:59",
        "is_active": true
    },
    "session_token": "세션토큰" (선택사항)
}
```

**응답 (실패)**:
```json
{
    "success": false,
    "message": "아이디 또는 비밀번호가 잘못되었습니다."
}
```

---

#### POST /api/logout
**요청**:
```json
{
    "user_id": "사용자아이디",
    "session_token": "세션토큰" (선택사항)
}
```

**응답**:
```json
{
    "success": true,
    "message": "로그아웃되었습니다."
}
```

---

### 2. MAC 주소 검증 API

#### POST /api/verify_mac_address
**요청**:
```json
{
    "user_id": "사용자아이디",
    "mac_address": "AA:BB:CC:DD:EE:FF",
    "hardware_id": "PC하드웨어ID" (선택사항)
}
```

**응답 (허용)**:
```json
{
    "success": true,
    "allowed": true,
    "message": "허용된 사용자입니다."
}
```

**응답 (차단)**:
```json
{
    "success": true,
    "allowed": false,
    "message": "등록되지 않은 사용자입니다. 관리자에게 문의하세요."
}
```

---

### 3. 사용자 계정 관리 API (관리자)

#### POST /api/create_user
**요청**:
```json
{
    "admin_key": "관리자키",
    "user_id": "사용자아이디",
    "password": "초기비밀번호",
    "name": "홍길동",
    "email": "user@example.com",
    "phone": "010-1234-5678"
}
```

**응답**:
```json
{
    "success": true,
    "message": "사용자 계정이 생성되었습니다.",
    "user_id": "사용자아이디"
}
```

---

#### POST /api/list_users
**요청**:
```json
{
    "admin_key": "관리자키"
}
```

**응답**:
```json
{
    "success": true,
    "users": [
        {
            "user_id": "사용자아이디",
            "name": "홍길동",
            "email": "user@example.com",
            "is_active": true,
            "created_date": "2025-01-15T10:00:00",
            "last_login": "2025-01-20T14:30:00",
            "expiry_date": "2025-12-31T23:59:59"
        },
        ...
    ]
}
```

---

### 4. MAC 주소 관리 API (관리자)

#### POST /api/register_mac_address
**요청**:
```json
{
    "admin_key": "관리자키",
    "user_id": "사용자아이디",
    "mac_address": "AA:BB:CC:DD:EE:FF",
    "device_name": "삼성 갤럭시 S21"
}
```

**응답**:
```json
{
    "success": true,
    "message": "MAC 주소가 등록되었습니다."
}
```

---

#### POST /api/list_user_mac_addresses
**요청**:
```json
{
    "admin_key": "관리자키" (선택사항, 관리자용),
    "user_id": "사용자아이디"
}
```

**응답**:
```json
{
    "success": true,
    "mac_addresses": [
        {
            "mac_address": "AA:BB:CC:DD:EE:FF",
            "device_name": "삼성 갤럭시 S21",
            "registered_date": "2025-01-15T10:00:00",
            "is_active": true
        },
        ...
    ]
}
```

---

#### POST /api/remove_mac_address
**요청**:
```json
{
    "admin_key": "관리자키",
    "user_id": "사용자아이디",
    "mac_address": "AA:BB:CC:DD:EE:FF"
}
```

**응답**:
```json
{
    "success": true,
    "message": "MAC 주소가 삭제되었습니다."
}
```

---

### 5. 사용량 기록 API

#### POST /api/record_user_usage
**요청**:
```json
{
    "user_id": "사용자아이디",
    "total_invoices": 100,
    "success_count": 95,
    "fail_count": 5,
    "mac_address": "AA:BB:CC:DD:EE:FF",
    "hardware_id": "PC하드웨어ID"
}
```

**응답**:
```json
{
    "success": true,
    "message": "사용량이 기록되었습니다."
}
```

---

### 6. 사용자 정보 조회 API

#### POST /api/user_info
**요청**:
```json
{
    "user_id": "사용자아이디"
}
```

**응답**:
```json
{
    "success": true,
    "user_info": {
        "user_id": "사용자아이디",
        "name": "홍길동",
        "email": "user@example.com",
        "expiry_date": "2025-12-31T23:59:59",
        "is_active": true,
        "subscription_type": "monthly"
    }
}
```

---

### 7. 구독 관리 API (관리자)

#### POST /api/extend_user_subscription
**요청**:
```json
{
    "admin_key": "관리자키",
    "user_id": "사용자아이디",
    "period_days": 30,
    "amount": 50000,
    "payment_method": "계좌이체",
    "note": "1월 사용료"
}
```

**응답**:
```json
{
    "success": true,
    "message": "구독이 연장되었습니다.",
    "expiry_date": "2025-02-28T23:59:59"
}
```

---

## 💻 클라이언트 프로그램 수정

### 1. 로그인 화면 추가

#### 위치: `src/gui_app.py`

**필요한 기능**:
- 로그인 창 (Toplevel 또는 초기 화면)
- 아이디 입력 필드
- 비밀번호 입력 필드 (마스킹)
- 로그인 버튼
- 에러 메시지 표시 영역
- "비밀번호 찾기" 기능 (선택사항)

**구현 위치**:
- `__init__` 메서드에서 기존 `check_license()` 대신 `show_login()` 호출
- `show_login()` 메서드 추가

---

### 2. 사용자 인증 모듈 추가

#### 위치: `src/user_auth_manager.py` (신규 파일)

**필요한 클래스/함수**:
```python
class UserAuthManager:
    def __init__(self, server_url: str)
    def login(self, user_id: str, password: str) -> Tuple[bool, str, Dict]
    def logout(self, user_id: str) -> bool
    def verify_mac_address(self, user_id: str, mac_address: str) -> Tuple[bool, str]
    def get_user_info(self, user_id: str) -> Dict
    def save_session(self, user_info: Dict)
    def load_session(self) -> Optional[Dict]
    def clear_session(self)
```

---

### 3. MAC 주소 확인 기능 추가

#### 위치: ESP32 펌웨어 수정 필요

**ESP32 펌웨어 수정** (`firmware/esp32_ble_hid/esp32_ble_hid.ino`):
- 연결된 모바일 기기의 MAC 주소를 시리얼로 전송하는 기능 추가
- 명령: "GET_CONNECTED_MAC" 수신 시 MAC 주소 전송

#### 위치: `src/bluetooth_controller.py` 수정

**추가 메서드**:
```python
def get_connected_mac_address(self) -> Optional[str]:
    """
    ESP32를 통해 연결된 모바일 기기의 MAC 주소 확인
    
    Returns:
        MAC 주소 (예: "AA:BB:CC:DD:EE:FF") 또는 None
    """
```

**동작 방식**:
1. 시리얼 통신으로 "GET_CONNECTED_MAC" 명령 전송
2. ESP32로부터 MAC 주소 수신
3. MAC 주소 반환

---

### 4. 세션 관리

#### 위치: `src/user_auth_manager.py` 또는 별도 파일

**세션 저장 위치**: `config/session.json`

**세션 정보**:
```json
{
    "user_id": "사용자아이디",
    "name": "홍길동",
    "login_time": "2025-01-20T10:00:00",
    "session_token": "세션토큰" (선택사항)
}
```

**기능**:
- 로그인 성공 시 세션 저장
- 프로그램 시작 시 세션 확인 (자동 로그인)
- 로그아웃 시 세션 삭제
- 세션 만료 확인

---

### 5. GUI 수정 사항

#### `src/gui_app.py` 수정 항목:

1. **초기화 부분**:
   - `check_license()` → `show_login()` 변경
   - `OnlineLicenseManager` → `UserAuthManager` 변경

2. **로그인 화면**:
   - `show_login()` 메서드 추가
   - 로그인 성공 시 메인 화면 표시
   - 로그인 실패 시 에러 메시지 표시

3. **사용자 정보 표시**:
   - 라이선스 정보 → 사용자 정보로 변경
   - 사용자 이름, 만료일 등 표시

4. **MAC 주소 검증**:
   - 프로그램 시작 시 MAC 주소 검증
   - 자동화 실행 전 MAC 주소 재검증
   - 검증 실패 시 팝업 표시 및 사용 차단

5. **사용량 기록**:
   - `record_usage()` 호출 시 `user_id` 포함

---

## 🖥️ 웹 관리 페이지 수정

### 1. 사용자 관리 페이지 추가

#### 위치: `server/templates/users.html` (신규)

**필요한 기능**:
- 사용자 목록 표시
- 사용자 추가 폼
- 사용자 정보 수정
- 사용자 활성화/비활성화
- 사용자 삭제

---

### 2. MAC 주소 관리 페이지 추가

#### 위치: `server/templates/mac_addresses.html` (신규) 또는 `index.html`에 통합

**필요한 기능**:
- 사용자별 MAC 주소 목록 표시
- MAC 주소 추가 폼
- MAC 주소 삭제
- MAC 주소 활성화/비활성화

---

### 3. 기존 관리 페이지 수정

#### 위치: `server/templates/index.html`

**수정 사항**:
- 라이선스 관리 → 사용자 관리로 변경
- 사용자별 MAC 주소 관리 탭 추가
- 사용자별 사용 통계 표시
- 사용자별 결제 내역 표시

---

## 📝 구현 순서

### Phase 1: 데이터베이스 구조 생성

1. **서버 코드 수정** (`server/license_server.py`):
   - `init_db()` 함수에 새로운 테이블 생성 코드 추가
   - PostgreSQL과 SQLite 모두 지원하도록 구현

2. **마이그레이션 스크립트** (선택사항):
   - 기존 데이터가 있다면 마이그레이션 스크립트 작성
   - 라이선스 키를 사용자 계정으로 변환

---

### Phase 2: 서버 API 구현

1. **인증 API**:
   - `POST /api/login` 구현
   - `POST /api/logout` 구현
   - 비밀번호 해싱 (bcrypt 사용)

2. **MAC 주소 검증 API**:
   - `POST /api/verify_mac_address` 구현

3. **사용자 관리 API**:
   - `POST /api/create_user` 구현
   - `POST /api/list_users` 구현

4. **MAC 주소 관리 API**:
   - `POST /api/register_mac_address` 구현
   - `POST /api/list_user_mac_addresses` 구현
   - `POST /api/remove_mac_address` 구현

5. **사용량 기록 API**:
   - `POST /api/record_user_usage` 수정 (user_id 포함)

---

### Phase 3: ESP32 펌웨어 수정

1. **MAC 주소 전송 기능 추가**:
   - 연결된 모바일 기기의 MAC 주소 확인
   - 시리얼 명령으로 MAC 주소 전송
   - "GET_CONNECTED_MAC" 명령 처리

---

### Phase 4: 클라이언트 프로그램 수정

1. **사용자 인증 모듈 생성**:
   - `src/user_auth_manager.py` 파일 생성
   - 로그인/로그아웃 기능 구현
   - MAC 주소 검증 기능 구현

2. **로그인 화면 추가**:
   - `src/gui_app.py`에 로그인 화면 추가
   - 기존 라이선스 검증 로직 제거

3. **MAC 주소 확인 기능 추가**:
   - `src/bluetooth_controller.py`에 MAC 주소 확인 메서드 추가

4. **세션 관리 구현**:
   - 세션 저장/로드 기능
   - 자동 로그인 기능

5. **MAC 주소 검증 통합**:
   - 프로그램 시작 시 MAC 주소 검증
   - 자동화 실행 전 MAC 주소 재검증

---

### Phase 5: 웹 관리 페이지 수정

1. **사용자 관리 페이지 추가**:
   - 사용자 목록/추가/수정/삭제 기능

2. **MAC 주소 관리 기능 추가**:
   - 사용자별 MAC 주소 관리

3. **기존 관리 페이지 수정**:
   - 사용자 중심으로 변경

---

## 🔒 보안 고려사항

### 1. 비밀번호 보안
- 비밀번호는 절대 평문으로 저장하지 않음
- bcrypt 또는 Argon2 사용 (bcrypt 권장)
- 비밀번호 정책 적용 (최소 길이, 복잡도 등)

### 2. 세션 관리
- 세션 토큰 사용 (선택사항)
- 세션 만료 시간 설정
- 로그아웃 시 세션 무효화

### 3. API 보안
- 관리자 API는 `admin_key` 검증 필수
- 일반 API는 사용자 인증 확인
- SQL Injection 방지 (파라미터화된 쿼리 사용)

### 4. MAC 주소 검증
- MAC 주소는 대소문자 구분 없이 비교
- MAC 주소 형식 검증
- 허용 목록에 없는 MAC 주소는 차단

---

## 📋 체크리스트

### 서버 구현
- [ ] 데이터베이스 테이블 생성 (users, user_subscriptions, allowed_mac_addresses, user_usage, user_payments)
- [ ] POST /api/login 구현
- [ ] POST /api/logout 구현
- [ ] POST /api/verify_mac_address 구현
- [ ] POST /api/create_user 구현
- [ ] POST /api/list_users 구현
- [ ] POST /api/register_mac_address 구현
- [ ] POST /api/list_user_mac_addresses 구현
- [ ] POST /api/remove_mac_address 구현
- [ ] POST /api/record_user_usage 수정 (user_id 포함)
- [ ] 비밀번호 해싱 (bcrypt) 구현

### ESP32 펌웨어
- [ ] MAC 주소 확인 기능 추가
- [ ] "GET_CONNECTED_MAC" 명령 처리

### 클라이언트 프로그램
- [ ] `src/user_auth_manager.py` 생성
- [ ] 로그인 화면 추가
- [ ] MAC 주소 확인 기능 추가 (`bluetooth_controller.py`)
- [ ] 세션 관리 구현
- [ ] MAC 주소 검증 통합
- [ ] 사용량 기록 수정 (user_id 포함)

### 웹 관리 페이지
- [ ] 사용자 관리 페이지 추가
- [ ] MAC 주소 관리 기능 추가
- [ ] 기존 관리 페이지 수정

### 테스트
- [ ] 사용자 생성 및 로그인 테스트
- [ ] MAC 주소 등록 및 검증 테스트
- [ ] 사용량 기록 테스트
- [ ] 관리자 기능 테스트

---

## 📚 참고 자료

### Python 라이브러리
- `bcrypt`: 비밀번호 해싱
- `requests`: HTTP 통신
- `pyserial`: 시리얼 통신 (기존)

### 데이터베이스
- PostgreSQL: Railway 프로덕션 환경
- SQLite: 로컬 개발 환경

---

## ⚠️ 주의사항

1. **기존 사용자 마이그레이션**:
   - 기존 라이선스 키 사용자가 있다면 마이그레이션 계획 수립
   - 데이터 손실 없이 전환

2. **하위 호환성**:
   - 기존 라이선스 키 방식과 병행 지원 여부 결정
   - 점진적 전환 또는 일괄 전환

3. **테스트**:
   - 충분한 테스트 후 프로덕션 배포
   - 사용자 피드백 수집

---

**작성일**: 2025-01-27  
**목적**: 사용자 계정 시스템 구현 가이드  
**대상**: 개발자








