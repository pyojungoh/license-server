# 작업 규칙

## ⚠️ 최우선순위 규칙 - 사용자-토큰 일치 정책

**중요 문제점**: PC 프로그램 로그인 사용자와 ESP32에 등록된 토큰 소유자가 다른데도 작동하는 문제가 있습니다.

### 코딩 시 반드시 고려해야 할 사항
- **1인 1아이디 정책**: 한 사용자의 아이디로만 사용할 수 있어야 함
- **사용자-토큰 일치 검증**: PC 프로그램 로그인 사용자와 ESP32 토큰 소유자가 일치해야만 작동해야 함
- **다른 사용자 접근 차단**: 다른 사용자의 토큰이 ESP32에 등록되어 있으면 차단해야 함
- 새로운 기능 개발 시 반드시 이 정책을 확인하고 적용해야 함

### 현재 제약사항 (ESP32 수정 불가)
- **ESP32 펌웨어 코드(`firmware/esp32_ble_hid/esp32_ble_hid.ino`)는 수정하지 말 것** (시판된 제품)
- ESP32에서 토큰 조회 기능을 가정한 코드 작성 금지
- PC 프로그램에서 ESP32에 등록된 토큰을 확인하는 기능 구현 불가 (ESP32 수정 불가)

### 해결 방향
- 새로운 기능 개발 시 사용자-토큰 일치 검증 로직을 고려하여 설계
- 다음 제품 출시 시 ESP32 펌웨어에 토큰 조회 기능 추가 예정
- 현재는 사용자 안내로 완화 (기술적 완벽한 해결은 ESP32 수정 필요)

### 참고 문서
- `ESP32_수정_불가_상황_정리.md`: 자세한 상황 설명 및 대응 방안

---

## 1. 문서 파일 생성 규칙
**작업하기 전까지는 md 파일 만들지 않기**

- 구현 가이드, 체크리스트, 작업 내역 등의 md 파일은 실제로 작업을 시작하기 전까지는 만들지 않는다.
- 작업 계획이나 요구사항 정리는 대화로 진행한다.
- 작업이 완료된 후에만 문서를 작성한다.

---

## 2. 코딩 작업 규칙
- 코드 수정 전에 현재 상태를 확인한다.
- 변경 사항은 명확한 커밋 메시지로 작성한다.
- 테스트 후 푸시한다.

---

## 3. 문서 작성 규칙
- 문서는 작업 완료 후에 작성한다.
- 중간에 문서가 필요하면 대화로 확인한다.
- 사용자가 명시적으로 요청한 경우에만 문서를 작성한다.

---

**중요**: 작업하기 전까지는 md 파일을 만들지 않는다!

---

## 📋 TODO - 향후 구현 항목

### 🔴 우선순위 1: 사용자 일치 검증 강화
**목표**: 모바일 앱과 PC 프로그램 로그인 아이디가 같아야만 작동하도록 구현

**작업 내용**:
1. PC 프로그램 시작 시 ESP32에 등록된 토큰의 소유자 확인
2. PC 프로그램 로그인 사용자와 토큰 소유자가 다르면 작업 차단
3. 사용자에게 명확한 오류 메시지 표시
4. 모바일 앱에서도 토큰 전송 전 사용자 상태 재확인 (선택사항)

**관련 파일**:
- `src/gui_app.py`: `start_automation()` 함수에서 검증 추가
- `src/user_auth_manager.py`: `check_token_owner()` 함수 활성화
- `server/license_server.py`: `/api/check_token_owner` API (이미 구현됨)

**제약사항**: ESP32에서 토큰을 조회할 수 없으므로, 다른 방법으로 검증해야 함 (서버 API 활용)

---

### 🟡 우선순위 2: 업데이트 메커니즘 구현
**목표**: 새 버전 배포 시 사용자가 프로그램을 교체해도 계속 사용 가능하도록

**작업 내용**:
1. 프로그램 버전 체크 기능 추가
   - 서버에 최신 버전 정보 API 추가 (`/api/check_version`)
   - 프로그램 시작 시 버전 확인
2. 업데이트 알림 기능
   - 새 버전이 있을 때 알림 표시 (강제 아님)
   - 다운로드 링크 제공
3. 하위 호환성 보장
   - 서버 API 변경 시 하위 호환성 유지
   - 구버전 프로그램도 계속 작동하도록 API 설계

**관련 파일**:
- `server/license_server.py`: 버전 체크 API 추가
- `src/gui_app.py`: 버전 체크 및 업데이트 알림 로직 추가
- `version.txt`: 버전 정보 파일

**참고**: 현재는 버전 체크가 없어 구버전 사용자가 계속 사용 가능하지만, 서버 API 변경 시 문제 발생 가능

---



