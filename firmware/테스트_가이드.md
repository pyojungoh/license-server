# ESP32 펌웨어 테스트 가이드

## 📋 테스트 전 준비사항

### 1. Arduino IDE 설정 확인
- [ ] Arduino IDE 설치 완료
- [ ] ESP32 보드 패키지 설치 완료
- [ ] ESP32 BLE Keyboard 라이브러리 설치 완료
- [ ] 보드: **ESP32 Dev Module** 선택
- [ ] 포트: **COMx** 선택 (ESP32 연결 확인)

### 2. 펌웨어 파일 열기
1. Arduino IDE 실행
2. **파일 → 열기**
3. `firmware/esp32_ble_hid/esp32_ble_hid.ino` 파일 선택

## 🔨 컴파일 테스트

### Step 1: 컴파일만 먼저 확인
1. **스케치 → 검증/컴파일** (Ctrl+R)
2. 하단 출력 창 확인

**정상 케이스:**
```
스케치가 컴파일되었습니다. 
보드: ESP32 Dev Module
```
- **파일 크기**: 약 1MB 정도 표시됨

**오류 케이스:**
- 오류 메시지 확인 후 아래 트러블슈팅 참고

### Step 2: 컴파일 오류 해결

#### 오류 1: `BLE2902.h: No such file or directory`
**해결**: 이미 코드에서 제거했으므로 발생하지 않아야 함

#### 오류 2: `BLEDevice::getServer() was not declared`
**원인**: BleKeyboard 라이브러리 버전 호환성 문제

**해결 방법 A (권장)**: 
- Arduino IDE에서 **스케치 → 라이브러리 포함하기 → 라이브러리 관리**
- `ESP32 BLE Keyboard` 검색 후 최신 버전으로 업데이트

**해결 방법 B**: 
- 코드 수정 필요 (NimBLE 라이브러리로 전환 고려)

#### 오류 3: `BLEServer*` 관련 타입 오류
**원인**: BLE 라이브러리 버전 불일치

**해결**: ESP32 보드 패키지 업데이트
1. **도구 → 보드 → 보드 관리자**
2. `esp32` 검색
3. 최신 버전으로 업데이트

## 📤 업로드 테스트

### Step 1: ESP32 연결 확인
1. ESP32를 USB 포트에 연결
2. 장치 관리자에서 COM 포트 확인
3. Arduino IDE에서 포트 선택

### Step 2: 업로드 실행
1. **스케치 → 업로드** (Ctrl+U)
2. 하단 진행 상태 확인

**정상 케이스:**
```
Connecting........_____
Writing at 0x00010000... (100%)
Leaving...
Hard resetting via RTS pin...
```

### Step 3: 업로드 오류 해결

#### 오류: `A fatal error occurred: Failed to connect to ESP32`
**해결:**
1. ESP32의 **BOOT 버튼**을 누른 상태에서 업로드 시작
2. "Connecting..." 메시지가 나오면 BOOT 버튼 떼기
3. 또는 USB 케이블 재연결

#### 오류: `Serial port 'COMx' already in use`
**해결:**
1. Arduino IDE의 **시리얼 모니터 닫기**
2. 다른 시리얼 통신 프로그램 종료
3. 다시 업로드 시도

## 📊 시리얼 모니터 확인

### Step 1: 시리얼 모니터 열기
1. **도구 → 시리얼 모니터** (Ctrl+Shift+M)
2. 오른쪽 하단 **보드레이트: 115200** 설정

### Step 2: 정상 출력 확인
업로드 성공 후 다음 메시지가 보여야 합니다:

```
=================================
ESP32 BLE HID 키보드 시작
=================================
✓ 블루투스 키보드 초기화 완료
✓ 토큰 수신 서비스 시작됨
  Service UUID: 12345678-1234-1234-1234-123456789ABC
  Characteristic UUID: 12345678-1234-1234-1234-123456789DEF

=================================
모바일 기기에서 '한진택배 스캐너'를 찾아 페어링하세요.
앱에서 인증 토큰을 전송하면 키보드 기능이 활성화됩니다.
=================================
```

### Step 3: 문제 상황별 확인

#### 문제: "✗ BLE 서버를 가져올 수 없습니다."
**원인**: BleKeyboard 라이브러리와 BLEDevice 호환성 문제

**해결:**
1. 라이브러리 업데이트
2. 또는 코드 수정 필요 (별도 안내 필요)

#### 문제: 아무 메시지도 안 나옴
**해결:**
1. ESP32 재부팅 (EN 버튼 누르거나 USB 재연결)
2. 시리얼 모니터 보드레이트 확인 (115200)
3. 시리얼 모니터 닫았다가 다시 열기

## 🔍 기능 테스트 (모바일 앱 준비 후)

### 1. 블루투스 연결 테스트
- 모바일에서 "한진택배 스캐너" 장치 검색
- 페어링 성공 확인
- 시리얼 모니터에 "✓ 블루투스 연결됨!" 메시지 확인

### 2. 토큰 수신 테스트 (모바일 앱 개발 후)
- 앱에서 토큰 전송
- 시리얼 모니터에 "→ 토큰 수신: ..." 메시지 확인
- "✓ 인증 성공! 키보드 기능 활성화됨" 메시지 확인

### 3. 키보드 입력 테스트
- PC에서 시리얼 통신으로 텍스트 전송
- 모바일 앱에서 입력 확인

## 📝 테스트 체크리스트

- [ ] 컴파일 성공
- [ ] 업로드 성공
- [ ] 시리얼 모니터에서 초기화 메시지 확인
- [ ] 토큰 수신 서비스 시작 메시지 확인
- [ ] 블루투스 연결 확인 (모바일에서 페어링 성공)
- [ ] 토큰 수신 확인 (모바일 앱 개발 후)
- [ ] 인증 성공 메시지 확인
- [ ] 키보드 입력 동작 확인

## ⚠️ 알려진 제한사항

1. **BLE 서버 호환성**: 
   - BleKeyboard 라이브러리 버전에 따라 `BLEDevice::getServer()`가 작동하지 않을 수 있음
   - 이 경우 NimBLE-Arduino 라이브러리로 전환 필요

2. **토큰 검증**: 
   - 현재는 단순 길이 체크만 수행
   - 실제 서버 검증은 모바일 앱에서 수행 권장
   - ESP32에서 직접 검증하려면 WiFi 연결 필요

## 🆘 추가 도움말

문제가 해결되지 않으면:
1. `ESP32_프로그래밍_가이드.md`의 트러블슈팅 섹션 참고
2. Arduino IDE의 컴파일 오류 메시지 전체 내용 확인
3. ESP32 보드 패키지 및 라이브러리 버전 확인






