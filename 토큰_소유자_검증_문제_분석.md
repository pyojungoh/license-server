# 토큰 소유자 검증 문제 분석

## 발견된 문제

사용자가 보고한 문제:
- 모바일 앱에서 사용자A가 로그인하여 토큰을 받고 ESP32로 전송
- PC 프로그램에서 사용자B가 로그인
- PC 프로그램에서 ESP32로 송장번호 전송이 가능함
- **문제**: PC 프로그램 로그인 사용자(user_id)와 ESP32에 등록된 토큰의 소유자(user_id)가 다른데도 작동함

## 현재 시스템 구조

1. **모바일 앱**: 사용자 로그인 → 토큰 발급 → ESP32로 토큰 전송
2. **ESP32**: 모바일 앱에서 받은 토큰을 서버에 검증 (`/api/verify_token`)
3. **PC 프로그램**: ESP32와 시리얼 통신으로 송장번호만 전송 (토큰을 직접 다루지 않음)

## 문제 분석

현재 시스템에서는:
- PC 프로그램이 ESP32에 등록된 토큰의 소유자를 확인하지 않음
- PC 프로그램은 단순히 송장번호만 전송
- ESP32는 토큰 검증만 수행하고, PC 프로그램 사용자와의 일치 여부는 확인하지 않음

## 해결 방안

### 옵션 1: PC 프로그램에서 토큰 소유자 확인 (권장)

PC 프로그램이 송장번호 전송 전에:
1. ESP32에 등록된 토큰을 조회 (ESP32 API 또는 시리얼 명령)
2. 서버 API (`/api/check_token_owner`)로 토큰 소유자 확인
3. PC 프로그램 로그인 사용자와 토큰 소유자가 일치하는지 확인
4. 일치하지 않으면 오류 메시지 표시 및 전송 차단

**문제점**: ESP32에서 토큰을 조회하는 방법이 필요함

### 옵션 2: 서버에서 추가 검증 (현재 구현 완료)

서버에 `/api/check_token_owner` API 추가 (이미 완료):
- PC 프로그램 사용자 ID와 토큰 소유자 ID 비교
- 일치 여부 반환

**필요한 작업**: PC 프로그램에서 이 API를 호출하도록 구현

### 옵션 3: ESP32 펌웨어 수정

ESP32가 토큰 검증 시 PC 프로그램 사용자 ID도 함께 검증하도록 수정

**문제점**: ESP32와 PC 프로그램 간 통신 프로토콜 변경 필요

## 현재 구현 상태

✅ **서버 API 추가 완료**: `/api/check_token_owner`
- 토큰과 PC 프로그램 사용자 ID를 받아서 일치 여부 확인

✅ **PC 프로그램 함수 추가 완료**: `UserAuthManager.check_token_owner()`
- 서버 API 호출 함수

⏳ **필요한 작업**:
1. ESP32에서 현재 등록된 토큰을 조회하는 방법 필요
2. PC 프로그램에서 토큰 조회 후 소유자 확인 로직 추가

## 질문

1. **ESP32에서 토큰을 조회할 수 있나요?**
   - 시리얼 명령으로 토큰을 조회할 수 있는가?
   - ESP32 펌웨어에 토큰 조회 기능이 있는가?

2. **현재 동작 방식**:
   - PC 프로그램이 ESP32에 토큰을 전송하는가?
   - 아니면 모바일 앱만 토큰을 전송하고, PC 프로그램은 단순히 송장번호만 전송하는가?

3. **원하는 동작**:
   - PC 프로그램 로그인 사용자와 토큰 소유자가 일치해야만 작동해야 하는가?
   - 일치하지 않으면 어떤 메시지를 표시해야 하는가?

## 다음 단계

사용자의 답변을 받은 후:
1. ESP32 펌웨어 확인 및 토큰 조회 기능 추가 (필요시)
2. PC 프로그램에서 토큰 소유자 확인 로직 구현
3. 테스트 및 검증


