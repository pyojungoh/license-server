# 구독 만료 시 토큰 발행 차단 구현 가이드

## 📋 목표
구독 기간이 만료된 사용자는 모바일 앱에서 토큰을 받을 수 없도록 차단하여, ESP32로 바코드 전송이 불가능하게 만듭니다.

## 🔍 현재 상태 분석

### 현재 동작
1. **모바일 앱 로그인 시**: 구독 만료 여부와 관계없이 토큰 발급
2. **PC 프로그램 로그인 시**: 구독 만료 여부와 관계없이 로그인 허용
3. **ESP32**: 토큰이 있으면 작동 (구독 만료 여부 무관)

### 문제점
- 구독이 만료되어도 토큰이 발급되어 ESP32가 작동함
- 사용자가 구독 연장 없이 계속 사용 가능

## 🎯 구현 목표

### 1. 모바일 앱 로그인 시 구독 만료 체크
- `expiry_date`가 현재 시간보다 이전이면 토큰 발급 차단
- 구독이 없는 경우도 차단
- 만료된 사용자에게 명확한 오류 메시지 전달

### 2. PC 프로그램 로그인 시 구독 만료 체크 (선택사항)
- PC 프로그램은 토큰을 사용하지 않지만, 일관성을 위해 체크 가능
- 또는 PC는 체크하지 않고 모바일만 체크

## 📝 수정할 파일

### 1. `server/license_server.py`
**위치**: `user_login` 함수 내부 (모바일 앱 로그인 처리 부분)

**현재 코드 위치**: 약 1706-1744번째 줄

**수정 내용**:
```python
# 구독 정보 조회 후 만료 여부 체크 추가
if sub_data:
    # expiry_date 파싱 (기존 코드)
    ...
    
    # ✨ 여기에 추가: 구독 만료 체크
    if expiry_date:
        now = datetime.datetime.now()
        if expiry_date < now:
            # 구독이 만료된 경우
            conn.close()
            return jsonify({
                'success': False,
                'message': f'구독이 만료되었습니다. (만료일: {expiry_date.strftime("%Y-%m-%d")}) 구독을 연장해주세요.',
                'code': 'SUBSCRIPTION_EXPIRED',
                'expiry_date': expiry_date.isoformat()
            }), 403
    else:
        # 구독이 없는 경우
        conn.close()
        return jsonify({
            'success': False,
            'message': '활성화된 구독이 없습니다. 관리자에게 문의하세요.',
            'code': 'NO_SUBSCRIPTION'
        }), 403
else:
    # 구독 정보가 없는 경우
    conn.close()
    return jsonify({
        'success': False,
        'message': '활성화된 구독이 없습니다. 관리자에게 문의하세요.',
        'code': 'NO_SUBSCRIPTION'
    }), 403
```

**구체적인 수정 위치**:
- `user_login` 함수 내부
- 모바일 앱 로그인 처리 부분 (약 1706-1744줄)
- `sub_data` 조회 후, 토큰 발급 전에 체크

### 2. `mobile_app/android/app/src/main/java/com/hanjin/LoginActivity.kt` (선택사항)
**목적**: 서버에서 반환된 오류 메시지를 사용자에게 표시

**확인 사항**:
- 현재 오류 메시지 표시 로직이 있는지 확인
- `SUBSCRIPTION_EXPIRED` 또는 `NO_SUBSCRIPTION` 코드 처리 추가

## 🔧 구현 단계

### Step 1: 서버 측 수정
1. `server/license_server.py` 파일 열기
2. `user_login` 함수 찾기 (약 1500번째 줄)
3. 모바일 앱 로그인 처리 부분 찾기 (약 1706-1744줄)
4. 구독 정보 조회 후 만료 체크 로직 추가
5. 만료된 경우 토큰 발급 전에 403 오류 반환

### Step 2: 테스트
1. 구독이 만료된 사용자로 모바일 앱 로그인 시도
2. 토큰이 발급되지 않는지 확인
3. 오류 메시지가 올바르게 표시되는지 확인
4. ESP32로 토큰 전송이 안 되는지 확인

### Step 3: 모바일 앱 오류 처리 개선 (선택사항)
1. `LoginActivity.kt`에서 구독 만료 오류 처리
2. 사용자에게 명확한 메시지 표시
3. 관리자에게 문의하도록 안내

## 📍 정확한 수정 위치

### `server/license_server.py` - `user_login` 함수

**찾아야 할 코드**:
```python
# 구독 정보 조회
if USE_POSTGRESQL:
    cursor.execute("""
        SELECT expiry_date FROM user_subscriptions 
        WHERE user_id = %s AND is_active = TRUE
        ORDER BY expiry_date DESC LIMIT 1
    """, (user_id,))
else:
    cursor.execute("""
        SELECT expiry_date FROM user_subscriptions 
        WHERE user_id = ? AND is_active = 1
        ORDER BY expiry_date DESC LIMIT 1
    """, (user_id,))

sub_data = cursor.fetchone()
expiry_date = None
if sub_data:
    try:
        if USE_POSTGRESQL:
            expiry_date_val = sub_data.get('expiry_date')
        else:
            expiry_date_val = sub_data[0] if len(sub_data) > 0 else None
        
        if expiry_date_val:
            if isinstance(expiry_date_val, str):
                expiry_date = datetime.datetime.fromisoformat(expiry_date_val)
            else:
                expiry_date = expiry_date_val
    except (IndexError, TypeError, ValueError):
        expiry_date = None

# ✨ 여기에 만료 체크 로직 추가
```

**추가할 코드** (토큰 발급 전):
```python
# 구독 만료 체크 (토큰 발급 전)
if not expiry_date:
    # 구독이 없는 경우
    conn.close()
    return jsonify({
        'success': False,
        'message': '활성화된 구독이 없습니다. 관리자에게 문의하세요.',
        'code': 'NO_SUBSCRIPTION'
    }), 403

# 구독 만료 여부 확인
now = datetime.datetime.now()
if expiry_date < now:
    # 구독이 만료된 경우
    conn.close()
    return jsonify({
        'success': False,
        'message': f'구독이 만료되었습니다. (만료일: {expiry_date.strftime("%Y-%m-%d")}) 구독을 연장해주세요.',
        'code': 'SUBSCRIPTION_EXPIRED',
        'expiry_date': expiry_date.isoformat()
    }), 403
```

## ✅ 체크리스트

### 구현 전
- [ ] 현재 코드 구조 이해
- [ ] `user_login` 함수 위치 확인
- [ ] 구독 정보 조회 부분 확인

### 구현 중
- [ ] 구독 만료 체크 로직 추가
- [ ] 구독 없음 체크 로직 추가
- [ ] 적절한 오류 메시지 작성
- [ ] 오류 코드 추가 (`SUBSCRIPTION_EXPIRED`, `NO_SUBSCRIPTION`)

### 구현 후
- [ ] 구독 만료된 사용자로 테스트
- [ ] 구독 없는 사용자로 테스트
- [ ] 정상 구독 사용자로 테스트
- [ ] 모바일 앱에서 오류 메시지 확인
- [ ] ESP32로 토큰 전송 불가 확인
- [ ] Railway 배포 후 실제 환경 테스트

## 🧪 테스트 시나리오

### 시나리오 1: 구독 만료된 사용자
1. 관리자 페이지에서 사용자의 구독 만료일을 과거 날짜로 설정
2. 해당 사용자로 모바일 앱 로그인 시도
3. **예상 결과**: 로그인 실패, "구독이 만료되었습니다" 메시지 표시
4. ESP32로 토큰 전송 시도
5. **예상 결과**: 토큰이 없으므로 ESP32 작동 안 함

### 시나리오 2: 구독 없는 사용자
1. 새로 가입한 사용자 (구독 연장 안 함)
2. 모바일 앱 로그인 시도
3. **예상 결과**: 로그인 실패, "활성화된 구독이 없습니다" 메시지 표시

### 시나리오 3: 정상 구독 사용자
1. 구독이 유효한 사용자
2. 모바일 앱 로그인 시도
3. **예상 결과**: 정상 로그인, 토큰 발급
4. ESP32로 토큰 전송
5. **예상 결과**: ESP32 정상 작동

## 📌 주의사항

1. **PC 프로그램 로그인**: 
   - PC는 토큰을 사용하지 않으므로, 구독 만료 체크는 선택사항
   - 모바일만 체크해도 충분할 수 있음

2. **기존 토큰 처리**:
   - 이미 발급된 토큰은 그대로 유효 (7일)
   - 새로 로그인할 때만 차단됨
   - 더 엄격하게 하려면 토큰 검증 시에도 구독 체크 추가 가능

3. **오류 메시지**:
   - 사용자에게 명확하고 친절한 메시지 제공
   - 관리자 연락 방법 안내

4. **데이터베이스**:
   - `user_subscriptions` 테이블의 `expiry_date` 컬럼 사용
   - `is_active = TRUE`인 구독만 확인

## 🔄 배포 순서

1. 로컬에서 테스트
2. GitHub에 커밋 및 푸시
3. Railway 자동 배포 대기 (1-2분)
4. 실제 환경에서 테스트
5. 문제 없으면 완료

## 📝 추가 개선 사항 (선택사항)

### 1. 토큰 검증 시에도 구독 체크
- ESP32로 토큰 전송 시 서버에서 구독 상태 재확인
- 구독이 만료되면 토큰 무효화

### 2. PC 프로그램 로그인 시에도 체크
- 일관성을 위해 PC 로그인도 구독 만료 시 차단
- 또는 PC는 체크하지 않고 모바일만 체크 (현재 권장)

### 3. 만료 전 경고
- 구독 만료 7일 전 경고 메시지
- 만료 1일 전 경고 메시지

---

**작성일**: 2025-01-05  
**예상 작업 시간**: 30분 - 1시간  
**우선순위**: 높음 (보안 관련)


