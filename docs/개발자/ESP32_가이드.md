# ESP32 가이드 (통합 문서)

**통합일**: 2025-01-26  
**통합된 문서**: ESP32 프로그래밍 가이드, ESP32 업로드 및 테스트, ESP32 테스트 안내, ESP32 수정 불가 상황 정리

---

## 📋 목차

1. [ESP32 수정 불가 제약사항](#esp32-수정-불가-제약사항)
2. [필수 준비물](#필수-준비물)
3. [드라이버 설치](#드라이버-설치)
4. [Arduino IDE 설정](#arduino-ide-설정)
5. [펌웨어 업로드](#펌웨어-업로드)
6. [블루투스 연결](#블루투스-연결)
7. [문제 해결](#문제-해결)

---

## ESP32 수정 불가 제약사항

### ⚠️ 중요: 현재 제품은 펌웨어 수정 불가

**상황**: 이미 시판된 제품으로 ESP32 펌웨어를 업데이트할 수 없습니다.

**제약사항**:
- **ESP32 펌웨어 수정 불가**: 시판된 제품이므로 펌웨어 업데이트 불가능
- **ESP32 토큰 조회 불가**: 현재 펌웨어에 토큰 조회 기능 없음
- **PC 프로그램이 ESP32 토큰 확인 불가**: ESP32를 통하지 않고는 토큰 정보를 알 수 없음

**코딩 시 주의사항**:
- **ESP32 펌웨어 코드(`firmware/esp32_ble_hid/esp32_ble_hid.ino`)는 수정하지 말 것**
- ESP32에서 토큰 조회 기능을 가정한 코드 작성 금지
- PC 프로그램에서 ESP32에 등록된 토큰을 확인하는 기능 구현 불가

**참고**: 작업규칙.md의 "최우선순위 규칙" 참조

---

## 필수 준비물

### 하드웨어
- **ESP32 WIFI + 블루투스 듀얼 모드 WROOM 32 USB C타입 CH340 드라이버**
- USB 케이블 (데이터 전송 가능한 케이블)
- PC (Windows)

### 소프트웨어
- Arduino IDE (최신 버전)
- CH340 드라이버
- ESP32 BLE Keyboard 라이브러리

---

## 드라이버 설치

### 1. CH340 드라이버 다운로드
- CH340 드라이버를 다운로드합니다.
- 다운로드 링크: [CH340 드라이버](https://www.wch.cn/downloads/CH341SER_EXE.html)
- 또는 제공된 `설치파일/CH341SER.EXE` 사용

### 2. 드라이버 설치
1. 다운로드한 드라이버 설치 파일 실행
2. "INSTALL" 버튼 클릭
3. 설치 완료 후 PC 재부팅 (필요한 경우)

### 3. 드라이버 설치 확인
1. ESP32를 PC에 USB로 연결
2. 장치 관리자에서 "COM 포트" 확인
3. "USB-SERIAL CH340" 또는 유사한 이름으로 표시되면 성공

**주의사항**: 
- 케이블이 데이터 전송을 지원하지 않으면 인식되지 않을 수 있습니다.
- 다른 케이블로 교체해보세요.

**자세한 내용**: `docs/사용자/DRIVER_INSTALL.md` 참조

---

## Arduino IDE 설정

### 1. Arduino IDE 설치
- [Arduino IDE 공식 사이트](https://www.arduino.cc/en/software)에서 다운로드
- 설치 완료 후 실행

### 2. ESP32 보드 패키지 추가
1. Arduino IDE 실행
2. **파일 → 환경설정** (또는 `Ctrl + ,`)
3. "추가 보드 관리자 URLs"에 다음 URL 추가:
   ```
   https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
   ```
4. **도구 → 보드 → 보드 관리자** 열기
5. 검색창에 "esp32" 입력
6. "esp32 by Espressif Systems" 설치 (버전 3.3.5 권장)

### 3. 보드 선택
1. **도구 → 보드 → ESP32 Arduino** → **ESP32 Dev Module** 선택
2. **도구 → 포트** → ESP32가 연결된 COM 포트 선택 (예: COM10)

### 4. 중요 설정
**도구 메뉴에서 다음 설정 확인:**
- **보드**: "ESP32 Dev Module"
- **Upload Speed**: "921600"
- **CPU Frequency**: "240MHz (WiFi/BT)"
- **Flash Frequency**: "80MHz"
- **Flash Mode**: "QIO"
- **Flash Size**: "4MB (32Mb)"
- **Partition Scheme**: "Default 4MB with spiffs (1.2MB APP/1.5MB SPIFFS)"
- **Core Debug Level**: "None"
- **PSRAM**: "Disabled"
- **Port**: ESP32가 연결된 COM 포트

### 5. 스케치북 위치 설정 (중요!)
**문제**: 한글 경로가 포함된 스케치북 위치는 컴파일 오류를 발생시킬 수 있습니다.

**해결 방법**:
1. **파일 → 환경설정** (또는 `Ctrl + ,`)
2. "스케치북 위치"를 영문 경로로 변경
   - 예: `C:\Arduino\Sketchbook`
   - 기존: `C:\Users\사용자명\OneDrive\문서\Arduino` (한글 경로)
3. Arduino IDE 재시작

---

## 펌웨어 업로드

### 1. 올바른 파일 열기

**⚠️ 중요: 올바른 파일 선택**
- **컴파일할 파일**: `firmware/esp32_ble_hid/esp32_ble_hid.ino` ✅  
- **컴파일하지 말 것**: `esp32_ble_hid_backup.ino` ❌ (인코딩 문제로 컴파일 안 됨)

**파일 열기 방법**:
1. **파일 → 열기** (Ctrl+O)
2. 다음 경로로 이동: `C:\hanjin\firmware\esp32_ble_hid\`
3. **`esp32_ble_hid.ino`** 파일 선택

### 2. 컴파일
1. **스케치 → 검증/컴파일** (Ctrl+R)
2. 하단 메시지에서 "스케치가 컴파일되었습니다." 확인

### 3. 업로드 준비
- [ ] ESP32가 USB 포트에 연결되어 있음
- [ ] Arduino IDE에서 포트 선택 확인 (도구 → 포트 → COMx)

### 4. 업로드
1. **스케치 → 업로드** (Ctrl+U) 클릭
2. 하단 출력 창에서 업로드 진행 상황 확인

**정상적인 업로드 과정:**
```
Connecting........_____
Writing at 0x00010000... (100%)
Leaving...
Hard resetting via RTS pin...
```

### 5. 업로드 오류 해결

#### 오류: "Failed to connect to ESP32"
**해결 방법:**
1. ESP32의 **BOOT 버튼**을 누른 상태에서 업로드 시작
2. "Connecting..." 메시지가 나오면 BOOT 버튼 떼기
3. 또는 USB 케이블을 뽑았다가 다시 연결

#### 오류: "Serial port 'COMx' already in use"
**해결 방법:**
1. Arduino IDE의 **시리얼 모니터 닫기**
2. 다른 시리얼 통신 프로그램 종료
3. 다시 업로드 시도

---

## 블루투스 연결

### 1. 시리얼 모니터 확인

#### 시리얼 모니터 열기
1. **도구 → 시리얼 모니터** (Ctrl+Shift+M)
2. 오른쪽 하단 **보드레이트: 115200** 설정

#### 예상 출력 메시지
업로드 성공 후 다음 메시지가 보여야 합니다:

```
=================================
ESP32 BLE HID 키보드 시작
=================================
✓ 블루투스 키보드 초기화 완료
✓ 토큰 수신 서비스 시작됨
  Service UUID: 12345678-1234-1234-1234-123456789ABC
  Characteristic UUID: 12345678-1234-1234-1234-123456789DEF

=================================
모바일 기기에서 '한진택배 스캐너'를 찾아 페어링하세요.
앱에서 인증 토큰을 전송하면 키보드 기능이 활성화됩니다.
=================================
```

### 2. 모바일 기기에서 연결
1. 모바일의 **블루투스 설정** 열기
2. 블루투스 장치 검색
3. **"한진택배 스캐너"** 장치 찾기
4. 페어링 요청 시 **"페어링"** 또는 **"연결"** 선택

### 3. 연결 확인
- 시리얼 모니터에 다음 메시지 표시:
  ```
  ✓ 블루투스 연결됨!
  ```

### 4. 토큰 수신 확인 (모바일 앱 사용 후)
1. 모바일 앱에서 ESP32로 토큰 전송
2. 시리얼 모니터에 다음 메시지 표시:
   ```
   → 토큰 수신: [토큰 내용]
   ✓ 인증 성공! 키보드 기능 활성화됨
   ```

---

## 문제 해결

### 시리얼 모니터에 아무것도 안 나옴
1. ESP32 재부팅 (USB 재연결)
2. 시리얼 모니터 보드레이트 확인 (115200)
3. 다른 USB 케이블 사용

### 블루투스 연결이 안 됨
1. ESP32 재부팅
2. 모바일 블루투스 재시작
3. 모바일에서 이전 연결 정보 삭제 후 다시 시도

### 업로드가 계속 실패
1. 다른 USB 포트 사용
2. 다른 USB 케이블 사용
3. ESP32 보드의 BOOT 버튼을 누른 상태에서 업로드 시작

### 컴파일 오류

#### 오류: `BLEDevice::getServer() was not declared`
**해결 방법**:
1. **스케치 → 라이브러리 포함하기 → 라이브러리 관리**
2. `ESP32 BLE Keyboard` 검색
3. 최신 버전으로 업데이트
4. 다시 컴파일

#### 오류: `BLECharacteristicCallbacks` 관련 오류
**해결 방법**:
1. **도구 → 보드 → 보드 관리자**
2. `esp32` 검색
3. 최신 버전으로 업데이트
4. 다시 컴파일

---

## 테스트 체크리스트

### 업로드 단계
- [ ] 컴파일 성공 확인
- [ ] ESP32 USB 연결 확인
- [ ] 포트 선택 확인 (COMx)
- [ ] 업로드 성공 확인
- [ ] 시리얼 모니터에서 초기화 메시지 확인

### 블루투스 연결 단계
- [ ] 모바일에서 "한진택배 스캐너" 장치 발견
- [ ] 블루투스 페어링 성공
- [ ] 시리얼 모니터에 "블루투스 연결됨" 메시지 확인

### 토큰 수신 단계
- [ ] 모바일 앱에서 토큰 전송
- [ ] 시리얼 모니터에 "토큰 수신" 메시지 확인
- [ ] "인증 성공" 메시지 확인

---

## 주의사항

1. **인증 없이는 키보드 작동 안 됨**
   - 모바일 앱에서 토큰을 보내기 전까지는 키보드 입력이 동작하지 않습니다
   - 이는 의도된 동작입니다 (보안 기능)

2. **BLE 서비스 UUID**
   - Service UUID: `12345678-1234-1234-1234-123456789ABC`
   - Characteristic UUID: `12345678-1234-1234-1234-123456789DEF`
   - 모바일 앱 개발 시 이 UUID를 사용해야 합니다

3. **시리얼 모니터와 업로드 충돌**
   - 업로드할 때는 시리얼 모니터를 닫아야 합니다
   - 업로드 후 다시 시리얼 모니터를 열어야 합니다

---

## 참고

- 작업규칙.md: ESP32 수정 불가 제약사항 상세 설명
- 펌웨어 소스코드: `firmware/esp32_ble_hid/esp32_ble_hid.ino`

