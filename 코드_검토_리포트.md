# 코드 검토 리포트

**검토 일자**: 2025-01-26  
**검토 범위**: 전체 프로젝트 (서버, PC 프로그램, 관리자 페이지)

---

## 📊 전체 평가

### ✅ 긍정적인 부분
1. **에러 처리**: 대부분의 API 엔드포인트에 try-except 블록이 잘 구현되어 있음
2. **데이터베이스 설계**: PostgreSQL과 SQLite를 모두 지원하는 잘 설계된 스키마
3. **보안**: 비밀번호 해싱(bcrypt), 토큰 해싱 등 기본 보안 조치 적용
4. **로깅**: 적절한 로깅 시스템 구축

### ⚠️ 개선 필요 사항

---

## 🔴 심각한 문제 (최우선 해결 필요)

### 1. **사용자-토큰 일치 검증 미구현** (작업규칙 위반)
**파일**: `src/gui_app.py`, `src/bluetooth_controller.py`

**문제점**:
- `gui_app.py`의 `verify_token_owner()` 함수가 있으나 실제로 `start_automation()`에서 호출되지 않음
- ESP32에서 토큰을 조회할 수 없어 검증이 불가능한 상태
- 다른 사용자의 토큰으로도 바코드 전송이 가능한 보안 취약점

**현재 코드**:
```python
# gui_app.py line 592
def verify_token_owner(self) -> bool:
    # 이 함수는 정의되어 있지만 실제로 호출되지 않음!
    ...
```

**권장 조치**:
- 작업규칙.md에 명시된 대로 1인 1아이디 정책을 준수해야 함
- ESP32 수정 불가 상황을 고려한 대안 필요 (사용자 안내, 경고 메시지 등)

### 2. **관리자 키 하드코딩**
**파일**: `server/license_server.py:26`

**문제점**:
```python
ADMIN_KEY = os.environ.get('ADMIN_KEY', '2133781qQ!!@#')  # 기본값이 하드코딩됨
```

**권장 조치**:
- 기본값 제거, 환경변수 필수로 변경
- 환경변수가 없으면 서버 시작 시 오류 발생하도록 수정

### 3. **데이터베이스 연결 종료 누락 가능성**
**파일**: `server/license_server.py` 여러 위치

**문제점**:
- 일부 함수에서 `finally` 블록에서 `conn.close()`를 호출하지만
- 중간에 return하는 경우 연결이 제대로 닫히지 않을 수 있음

**예시**:
```python
# line 2385-2391
if mac_data:
    conn.close()  # 여기서 return하면 나머지 코드 실행 안 됨
    return jsonify(...)
else:
    conn.close()
    return jsonify(...)
```

**권장 조치**:
- `with` 문 또는 context manager 사용 권장
- 또는 모든 return 경로에서 `finally` 블록 보장

---

## 🟡 중요 개선 사항

### 4. **에러 처리 일관성 부족**
**파일**: `server/license_server.py`

**문제점**:
- 일부 함수는 `except Exception as e:`로 모든 예외를 잡지만
- 일부는 특정 예외만 처리
- 에러 메시지가 사용자에게 노출될 수 있음

**예시**:
```python
except Exception as e:
    logger.error(f"오류: {e}", exc_info=True)
    return jsonify({'success': False, 'message': f'오류: {str(e)}'}), 500
    # str(e)가 민감한 정보를 포함할 수 있음
```

**권장 조치**:
- 프로덕션 모드에서는 일반적인 에러 메시지만 반환
- 디버그 모드에서만 상세 정보 반환

### 5. **SQL Injection 방어 확인 필요**
**파일**: `server/license_server.py`

**상태**: ✅ 대부분의 쿼리에서 파라미터화된 쿼리 사용 (`%s`, `?`)

**주의 사항**:
- `db_helper.py`의 `execute_query` 함수에서 `query.replace('?', '%s')` 사용
- 이 방식은 복잡한 쿼리에서 문제가 될 수 있음 (예: 문자열 내부의 `?`)

**권장 조치**:
- PostgreSQL과 SQLite를 완전히 분리하여 처리
- 또는 SQLAlchemy 같은 ORM 사용 고려

### 6. **세션 만료 처리**
**파일**: `src/user_auth_manager.py:69-85`

**현재 구현**:
```python
def is_session_expired(self) -> bool:
    # 1시간 후 만료
    return elapsed >= 3600
```

**문제점**:
- 세션 만료 확인이 자동으로 이루어지지 않음
- GUI 앱에서 주기적으로 확인 필요

**권장 조치**:
- `gui_app.py`에서 주기적으로 세션 만료 확인
- 또는 백그라운드 스레드에서 자동 확인

### 7. **하드웨어 ID 검증 누락 가능성**
**파일**: `src/user_auth_manager.py:196-245`

**문제점**:
- `verify_mac_address` 함수가 있으나 실제로 필수적으로 호출되지 않음
- `gui_app.py`의 `verify_mac_address_optional()`이 선택사항으로 처리

**권장 조치**:
- 사용 정책에 따라 필수 또는 선택 결정
- 필수라면 검증 실패 시 작업 중단

---

## 🟢 경미한 개선 사항

### 8. **중복 코드**
**파일**: `server/license_server.py`

**문제점**:
- PostgreSQL과 SQLite 쿼리가 거의 동일하지만 중복 작성
- 예: `get_pricing_settings`, `update_pricing_settings` 등

**권장 조치**:
- 헬퍼 함수로 추출하여 중복 제거

### 9. **매직 넘버**
**파일**: 여러 파일

**문제점**:
```python
time.sleep(2)  # 왜 2초인가?
timeout_time = time.time() + 3.0  # 왜 3초인가?
```

**권장 조치**:
- 상수로 정의하여 의미 명확화
```python
SERIAL_CONNECTION_STABILIZE_DELAY = 2.0
MAC_ADDRESS_RESPONSE_TIMEOUT = 3.0
```

### 10. **로깅 레벨**
**파일**: `src/bluetooth_controller.py`, 기타

**문제점**:
- `logger.debug()` 사용이 많지만 실제 디버그 레벨 설정이 불명확

**권장 조치**:
- 로깅 레벨을 설정 파일로 관리
- 프로덕션/개발 모드에 따라 레벨 조정

### 11. **HTML/JavaScript 코드 구조**
**파일**: `server/templates/index.html`

**문제점**:
- JavaScript 코드가 HTML 파일 내부에 인라인으로 포함
- 코드가 매우 길어서 유지보수 어려움 (1400+ 줄)

**권장 조치**:
- JavaScript를 별도 파일로 분리
- 모듈화하여 관리 용이하게

### 12. **에러 메시지 일관성**
**파일**: 전체

**문제점**:
- 일부는 한국어, 일부는 영어
- 에러 메시지 형식이 일관되지 않음

**권장 조치**:
- 모든 에러 메시지를 한국어로 통일
- 메시지 포맷 표준화

---

## 🔍 코드 품질 상세 분석

### 서버 (`server/license_server.py`)

**강점**:
- ✅ 41개의 API 엔드포인트가 잘 구조화되어 있음
- ✅ 데이터베이스 초기화 로직이 안전함 (기존 데이터 보존)
- ✅ PostgreSQL과 SQLite 모두 지원

**약점**:
- ⚠️ 파일이 매우 큼 (3974줄) - 모듈화 필요
- ⚠️ 일부 함수가 너무 김 (100줄 이상)
- ⚠️ 테이블 생성 로직이 여러 곳에 분산

**권장 리팩토링**:
```python
# 제안: 모듈 분리
server/
  ├── license_server.py (메인 앱)
  ├── routes/
  │   ├── auth.py (인증 관련)
  │   ├── users.py (사용자 관리)
  │   ├── payments.py (결제 관리)
  │   └── admin.py (관리자 기능)
  ├── database/
  │   ├── models.py (데이터베이스 모델)
  │   └── migrations.py (마이그레이션)
  └── utils/
      ├── security.py (보안 함수)
      └── validators.py (검증 함수)
```

### PC 프로그램 (`src/gui_app.py`)

**강점**:
- ✅ GUI 구조가 잘 설계됨
- ✅ 로그 시스템이 잘 구현됨
- ✅ 에러 처리 및 사용자 피드백이 적절함

**약점**:
- ⚠️ `gui_app.py`가 너무 큼 (1133줄) - 클래스 분리 필요
- ⚠️ `verify_token_owner()` 함수가 정의되어 있으나 사용되지 않음
- ⚠️ 하드웨어 검증이 선택사항으로 처리됨

**권장 개선**:
- GUI 로직과 비즈니스 로직 분리
- 토큰 검증 로직 활성화 또는 제거 결정 필요

### 블루투스 컨트롤러 (`src/bluetooth_controller.py`)

**강점**:
- ✅ 시리얼 통신 로직이 잘 구현됨
- ✅ 모니터링 스레드가 적절히 관리됨
- ✅ 에러 처리 및 타임아웃 처리 적절함

**약점**:
- ⚠️ `get_token()` 함수가 있으나 ESP32에서 지원하지 않음
- ⚠️ 함수는 있으나 실제로 작동하지 않는 상태

**권장 조치**:
- ESP32 수정 불가 상황을 반영하여 함수 제거 또는 주석 처리
- 또는 작업규칙에 명시된 대로 사용자 안내 메시지 추가

---

## 🔐 보안 검토

### ✅ 잘 구현된 부분
1. 비밀번호 해싱: bcrypt 사용
2. 토큰 해싱: SHA256 사용
3. SQL Injection 방어: 파라미터화된 쿼리 사용
4. CORS 설정: Flask-CORS 사용

### ⚠️ 개선 필요
1. **관리자 키**: 기본값 제거 필요
2. **에러 메시지**: 민감한 정보 노출 방지
3. **세션 관리**: 세션 토큰 생성 및 검증 강화
4. **토큰 만료**: 토큰 만료 시간 검증 강화
5. **사용자-토큰 일치 검증**: 작업규칙 준수 필요

---

## 📝 데이터베이스 검토

### 스키마 설계
✅ **잘 설계된 부분**:
- 인덱스가 적절히 생성됨
- 외래 키 제약 조건 사용
- ON DELETE CASCADE 사용으로 데이터 무결성 보장

⚠️ **개선 필요**:
- 트랜잭션 처리: 일부 함수에서 명시적 트랜잭션 시작/커밋 필요
- 연결 풀링: PostgreSQL의 경우 연결 풀링 고려

### 테이블 구조
1. `users`: ✅ 잘 설계됨
2. `user_subscriptions`: ✅ 잘 설계됨
3. `user_payments`: ✅ 잘 설계됨
4. `user_access_tokens`: ✅ 잘 설계됨 (토큰 해시 저장)
5. `allowed_mac_addresses`: ✅ 잘 설계됨
6. `subscription_pricing`: ✅ 잘 설계됨
7. `payment_methods`: ✅ 잘 설계됨

---

## 🧪 테스트 가능성

### 현재 상태
- ❌ 단위 테스트 없음
- ❌ 통합 테스트 없음
- ❌ API 테스트 없음

### 권장 사항
1. **단위 테스트 추가**:
   - `user_auth_manager.py`의 각 함수
   - `bluetooth_controller.py`의 주요 함수
   - 서버 API 엔드포인트

2. **통합 테스트 추가**:
   - 로그인 → 토큰 발급 → 사용 플로우
   - 결제 → 구독 연장 플로우

3. **테스트 도구**:
   - `pytest` 사용 권장
   - `unittest.mock`으로 외부 의존성 모킹

---

## 📋 작업규칙 준수 여부

### ✅ 준수된 부분
1. 문서 파일 생성 규칙: 작업 완료 후 문서 작성
2. 커밋 메시지: 명확한 커밋 메시지 사용

### ❌ 위반된 부분
1. **최우선순위 규칙 위반**: 
   - "1인 1아이디 정책" 미준수
   - "사용자-토큰 일치 검증" 미구현
   - `verify_token_owner()` 함수가 있으나 사용되지 않음

---

## 🎯 우선순위별 개선 권장 사항

### 🔴 최우선 (보안 및 기능)
1. **사용자-토큰 일치 검증 구현** (작업규칙 준수)
   - ESP32 수정 불가 상황 반영
   - 사용자 안내 메시지 추가 또는 기능 제한
   
2. **관리자 키 기본값 제거**
   - 환경변수 필수로 변경
   
3. **데이터베이스 연결 관리 개선**
   - context manager 사용

### 🟡 높은 우선순위 (안정성)
4. **에러 메시지 보안 강화**
   - 프로덕션 모드에서 일반 메시지만 반환
   
5. **세션 만료 자동 확인**
   - GUI 앱에서 주기적 확인 추가

6. **SQL Injection 방어 강화**
   - PostgreSQL/SQLite 쿼리 분리 또는 ORM 사용

### 🟢 중간 우선순위 (유지보수성)
7. **코드 모듈화**
   - 서버 코드 분리 (routes, models, utils)
   - GUI 앱 클래스 분리
   
8. **매직 넘버 상수화**
   
9. **JavaScript 코드 분리**
   - HTML에서 JavaScript 분리

### 🔵 낮은 우선순위 (코드 품질)
10. **테스트 코드 추가**
11. **로깅 레벨 관리**
12. **에러 메시지 일관성**

---

## 📌 결론

전반적으로 코드는 잘 작성되어 있으며, 기본적인 보안 조치와 에러 처리가 구현되어 있습니다. 하지만 **작업규칙.md에 명시된 최우선순위 규칙(1인 1아이디 정책, 사용자-토큰 일치 검증)이 준수되지 않았으며**, 이것이 가장 중요한 보안 취약점입니다.

**즉시 조치 필요**:
1. 사용자-토큰 일치 검증 로직 활성화 또는 대안 구현
2. 관리자 키 기본값 제거
3. 데이터베이스 연결 관리 개선

이러한 개선을 통해 보안성과 안정성을 크게 향상시킬 수 있습니다.

---

**검토자**: AI Assistant  
**검토 완료 일시**: 2025-01-26

