# 작업 내역

## 날짜: 2025년 1월 (최근 작업)

---

## 주요 작업 내용

### 1. 사이트 접속 문제 해결
**문제**: Railway 배포 후 사이트 접속 불가
**원인**: `wsgi.py`에서 PostgreSQL 연결 실패 시 `sys.exit(1)`로 앱이 종료됨
**해결**:
- `sys.exit(1)` 제거
- `init_db()` 실패해도 앱은 시작되도록 수정
- 에러는 로깅만 하고 계속 진행

**수정 파일**: `server/wsgi.py`

---

### 2. PostgreSQL 연결 문제 해결
**문제**: 데이터베이스 상태가 SQLite로 표시됨
**원인**: `DATABASE_URL` 감지 로직이 `postgres`로만 시작하는지 체크
**해결**:
- `postgresql://` 또는 `postgres://`로 시작하는지 정확히 체크
- Health check에 디버그 정보 추가 (`database_url_preview`, `database_url_starts_with`)

**수정 파일**: `server/license_server.py`
```python
# 변경 전
USE_POSTGRESQL = bool(DATABASE_URL and DATABASE_URL.startswith('postgres'))

# 변경 후
USE_POSTGRESQL = bool(DATABASE_URL and (DATABASE_URL.startswith('postgresql://') or DATABASE_URL.startswith('postgres://')))
```

---

### 3. 라이선스 목록 API 오류 수정
**문제**: `/api/list_licenses` API가 500 에러 반환
**원인**: 
- PostgreSQL의 `RealDictCursor`에서 인덱스 접근 (`usage_data[0]`) 사용
- 날짜 형식 변환 오류

**해결**:
- `RealDictCursor` 사용 시 딕셔너리 접근 방식으로 변경 (`usage_data.get('run_count')`)
- 날짜 형식 변환 안전하게 처리
- 모든 필드에 기본값 제공

**수정 파일**: `server/license_server.py` - `list_licenses()` 함수

---

### 4. 라이선스 중지/활성화 기능 추가
**기능**: 관리 시스템에서 라이선스를 중지/활성화할 수 있는 기능
**구현 내용**:
- API 엔드포인트 추가: `/api/toggle_license`
- 라이선스 목록 테이블에 "작업" 컬럼 추가
- 각 라이선스마다 "중지" 또는 "활성화" 버튼 표시
- 상태 표시 개선 (활성/만료/중지 구분)

**수정 파일**:
- `server/license_server.py` - `toggle_license()` 함수 추가
- `server/templates/index.html` - UI 추가 및 JavaScript 함수 추가

**사용 방법**:
1. 관리 시스템 → "라이선스 목록" 탭
2. 각 라이선스의 "작업" 컬럼에서 "중지" 또는 "활성화" 버튼 클릭
3. 확인 대화상자에서 확인
4. 상태가 업데이트되고 목록이 자동 새로고침됨

---

### 5. 중지 기능이 클라이언트에 반영되도록 수정
**문제**: 관리 시스템에서 라이선스를 중지해도 클라이언트 프로그램에서 계속 사용 가능
**원인**: 
- 클라이언트가 온라인 검증 실패 시 로컬 검증으로 폴백
- 프로그램 시작 시 강제 온라인 검증 미구현

**해결**:
- 프로그램 시작 시 강제 온라인 검증 (`force_online=True`)
- 자동화 시작 전에도 라이선스 검증 수행
- 서버의 `/api/verify` 엔드포인트에서 `is_active = TRUE` 조건 확인

**수정 파일**: 
- `src/gui_app.py` - `check_license()`, `start_automation()` 함수 수정
- `src/online_license_manager.py` - `verify_license()` 함수는 이미 구현되어 있음

**동작 방식**:
1. 프로그램 시작 시: 서버에서 라이선스 상태 확인, `is_active = FALSE`이면 프로그램 사용 불가
2. 자동화 시작 시: 서버에서 라이선스 상태 재확인, 중지된 라이선스는 "라이선스 검증 실패" 메시지 표시

---

### 6. 개발 모드 추가
**목적**: 개발 환경에서 라이선스 검증을 우회하여 테스트 가능하도록 함
**구현 내용**:
- `config/dev_mode.txt` 파일로 개발 모드 제어
- 파일 내용이 `true`이면 라이선스 검증 우회
- 파일 내용이 `false`이거나 파일이 없으면 정상 검증 수행

**수정 파일**:
- `src/online_license_manager.py` - 개발 모드 체크 로직 추가
- `src/gui_app.py` - 개발 모드 체크 로직 추가
- `config/dev_mode.txt` - 개발 모드 설정 파일 생성

**사용 방법**:
- 개발 모드 활성화: `config/dev_mode.txt` 파일에 `true` 입력
- 개발 모드 비활성화: `config/dev_mode.txt` 파일에 `false` 입력 또는 파일 삭제

---

## 데이터베이스 관련

### PostgreSQL 설정
- Railway에서 PostgreSQL 서비스 생성
- Flask 앱 서비스의 Variables에 `DATABASE_URL` 설정
- `DATABASE_URL`은 `postgresql://` 또는 `postgres://`로 시작해야 함

### 테이블 구조
- `licenses`: 라이선스 정보 저장
  - `is_active`: 라이선스 활성화 상태 (BOOLEAN)
- `subscriptions`: 구독 정보 저장
- `usage_stats`: 사용 통계 저장

---

## API 엔드포인트

### 추가된 엔드포인트
- `POST /api/toggle_license`: 라이선스 활성화/비활성화 토글
  - 요청: `{"admin_key": "...", "license_key": "..."}`
  - 응답: `{"success": true, "message": "...", "is_active": true/false}`

### 수정된 엔드포인트
- `POST /api/list_licenses`: PostgreSQL RealDictCursor 처리 개선
- `POST /api/verify`: 이미 `is_active = TRUE` 조건 확인 중

---

## 클라이언트 프로그램 변경사항

### 라이선스 검증 강화
- 프로그램 시작 시 강제 온라인 검증
- 자동화 시작 전 라이선스 검증
- 중지된 라이선스는 즉시 차단

### 개발 모드 지원
- `config/dev_mode.txt` 파일로 개발 모드 제어
- 개발 모드 활성화 시 라이선스 검증 우회

---

## 배포 관련

### Railway 배포
- PostgreSQL 서비스 연결 확인
- `DATABASE_URL` 환경 변수 설정 확인
- Health check 엔드포인트로 연결 상태 확인 가능

### 클라이언트 프로그램
- 변경사항 적용을 위해 프로그램 재빌드 필요
- PyInstaller로 `.exe` 파일 생성
- Inno Setup으로 설치 파일 생성

---

## 다음 작업 예정

1. 프로그램 재빌드 및 배포
2. 라이선스 중지 기능 테스트
3. 개발 모드 테스트
4. 사용자 매뉴얼 업데이트

---

## 참고 사항

### 파일 구조
```
hanjin/
  config/
    dev_mode.txt          # 개발 모드 설정
    license.json          # 로컬 라이선스 정보
    settings.json         # 프로그램 설정
  server/
    license_server.py     # Flask 서버
    wsgi.py              # WSGI 엔트리 포인트
    templates/
      index.html         # 관리 시스템 UI
  src/
    gui_app.py           # GUI 애플리케이션
    online_license_manager.py  # 온라인 라이선스 관리
```

### 중요 설정 파일
- `config/dev_mode.txt`: 개발 모드 활성화/비활성화
- `config/settings.json`: 프로그램 설정 (라이선스 서버 URL 포함)
- Railway Variables: `DATABASE_URL`, `ADMIN_KEY`

---

## 문제 해결 체크리스트

### 사이트 접속 안 될 때
1. Railway 대시보드에서 서비스 상태 확인
2. Logs 탭에서 에러 메시지 확인
3. `DATABASE_URL` 환경 변수 확인

### 라이선스 목록이 안 나올 때
1. 브라우저 개발자 도구(F12) → Network 탭 확인
2. `/api/list_licenses` 요청의 Response 확인
3. Railway Logs에서 서버 에러 확인

### 라이선스 중지가 안 될 때
1. PostgreSQL 연결 상태 확인
2. `RealDictCursor` 사용 확인
3. Railway Logs에서 에러 확인

### 클라이언트에서 중지가 반영 안 될 때
1. 프로그램 재시작 확인
2. 인터넷 연결 확인
3. 라이선스 서버 URL 확인 (`config/settings.json`)

---

## Git 커밋 내역

```
- Fix: Allow app to start even if database initialization fails
- Fix PostgreSQL detection: check for postgresql:// prefix and add debug info
- Fix: Improve error handling in list_licenses API to return JSON instead of HTML
- Fix: Correct syntax error in list_licenses function
- Fix: Improve error handling in list_licenses - safe data extraction for PostgreSQL RealDictCursor
- Add: License activation/deactivation toggle feature in license list
- Fix: Handle RealDictCursor in toggle_license API for PostgreSQL
- Fix: Force online license verification on program start and before automation
- Add: Development mode to bypass license verification for developers
```

---

작성일: 2025년 1월
작성자: AI Assistant










