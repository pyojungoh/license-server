# ESP32 수정 불가 상황 - 토큰 소유자 검증 대응 방안

## 문제 상황

- **ESP32 펌웨어 수정 불가**: 이미 시판된 제품이라 ESP32 펌웨어를 업데이트할 수 없음
- **기존 문제**: PC 프로그램 로그인 사용자와 ESP32에 등록된 토큰 소유자가 다를 수 있음

## 현재 시스템 구조

1. **모바일 앱**: 사용자 로그인 → 토큰 발급 → ESP32로 토큰 전송 (BLE)
2. **ESP32**: 모바일 앱에서 받은 토큰 저장 (메모리만, 조회 불가)
3. **PC 프로그램**: ESP32로 송장번호 전송 (시리얼)
4. **서버**: 토큰 정보 저장 (user_access_tokens 테이블: user_id, device_uuid, access_token)

## 제약사항

- ESP32에서 토큰 조회 불가 (펌웨어 수정 불가)
- PC 프로그램이 ESP32에 등록된 토큰을 직접 확인할 수 없음
- 모바일 앱과 PC 프로그램 간 직접 통신 없음

## 대응 방안 분석

### 방안 1: 서버에서 최근 활성 토큰 조회 (제한적)

**아이디어**: PC 프로그램 사용자 ID로 서버에서 최근 활성화된 토큰 조회

**문제점**:
- 서버에서 PC 프로그램 사용자의 최근 토큰을 찾을 수는 있음
- 하지만 **ESP32에 실제로 등록된 토큰**과 일치하는지 확인할 수 없음
- 다른 사용자의 토큰이 ESP32에 있을 수 있음

**결론**: 실제 ESP32의 토큰과 비교할 수 없어 해결 불가

### 방안 2: 모바일 앱 사용자 ID를 서버에 저장 (복잡)

**아이디어**: 모바일 앱에서 토큰 전송 시 서버에 "현재 ESP32에 등록된 사용자" 정보 저장

**구현 방법**:
- 모바일 앱에서 토큰 전송 시 서버 API 호출: "ESP32에 토큰 전송 완료" 알림
- PC 프로그램에서 서버 API 호출: "ESP32에 등록된 사용자 조회"
- 비교하여 일치 여부 확인

**문제점**:
- 모바일 앱 수정 필요
- 서버 API 추가 필요
- ESP32와 PC 프로그램 간 매핑 방법 필요 (ESP32 식별 방법?)
- 복잡하고 신뢰성 낮음 (모바일 앱이 꺼지면 정보가 오래될 수 있음)

**결론**: 구현 가능하나 복잡하고 신뢰성 낮음

### 방안 3: 사용자 안내 및 수동 확인 (현실적)

**아이디어**: 기술적 해결 대신 사용자 안내

**구현 방법**:
- PC 프로그램 시작 시 안내 메시지: "모바일 앱에서 현재 로그인한 사용자의 토큰을 ESP32로 전송했는지 확인하세요"
- 또는 모바일 앱에서 토큰 전송 시 사용자 ID 표시

**결론**: 기술적 해결은 아니지만, 사용자 교육으로 문제 완화 가능

### 방안 4: 현재 상태 유지 (권장)

**분석**:
- 현재 시스템에서 PC 프로그램 사용자와 토큰 소유자가 다르면 **실제로 문제가 되는가?**
- ESP32는 단순히 키보드 입력만 수행
- 송장번호 전송은 PC 프로그램 사용자가 제어
- **통계 기록**은 PC 프로그램 사용자 ID로 기록됨 (현재 `record_usage`에서 `self.current_user_id` 사용)

**현재 동작**:
- PC 프로그램에서 사용자A로 로그인
- 모바일 앱에서 사용자B의 토큰이 ESP32에 등록됨
- PC 프로그램에서 송장번호 전송
- 통계는 사용자A로 기록됨 (PC 프로그램 로그인 사용자)
- ESP32는 단순히 키보드 입력만 수행

**문제점**:
- 사용자B의 토큰으로 ESP32가 활성화되어 있지만, 사용자A가 송장번호를 전송
- 하지만 실제 기능상 문제는 없음 (ESP32는 단순 키보드 입력만 수행)

**결론**: 기능상 문제가 없을 수 있으나, 보안/정책상 검증이 필요하다면 방안 2나 3 고려

## 권장 사항

### 옵션 A: 현재 상태 유지 (단기)

- ESP32 수정 불가 상황에서는 기술적 해결이 어려움
- 현재 시스템이 기능상 문제 없이 작동 중
- 사용자 안내로 문제 완화

### 옵션 B: 모바일 앱 + 서버 연동 (중기, 복잡)

- 모바일 앱에서 토큰 전송 시 서버에 알림
- PC 프로그램에서 서버 조회하여 확인
- 구현 복잡도 높음, 신뢰성 낮음

### 옵션 C: 다음 제품 출시 시 해결 (장기)

- ESP32 펌웨어에 GET_TOKEN 명령 추가
- PC 프로그램에서 토큰 조회 후 검증
- 가장 확실한 해결 방법

## 결론

**ESP32 펌웨어를 수정할 수 없는 현재 상황에서는 완벽한 기술적 해결이 어렵습니다.**

다음 중 선택:
1. **현재 상태 유지** (기능상 문제 없음)
2. **사용자 안내 강화** (기술적 해결 아님)
3. **복잡한 모바일 앱 + 서버 연동** (구현 복잡, 신뢰성 낮음)
4. **다음 제품 출시 시 해결** (장기 계획)

어떤 방향으로 진행하시겠습니까?


